{% extends 'base.html' %}
{% block content %}
<div class="hero">
  <h1>{{ t('appeal.page_title') }}</h1>
  <p class="text-secondary">{{ t('appeal.page_subtitle_prefix') }}{{ (sub.professor_cn_name or '') ~ ' ' ~ (sub.professor_en_name or '') }}{{ t('appeal.page_subtitle_suffix') }}</p>
</div>

<div class="container-narrow">
  <div class="card">
    <form action="/appeal/{{ sub.id }}" method="post" enctype="multipart/form-data">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
      
      <div class="form-group">
        <label for="email">{{ t('appeal.your_email') }}</label>
        <input id="email" type="email" name="email" required placeholder="you@example.com" />
      </div>

      <div class="form-group">
        <label for="reason">{{ t('appeal.appeal_reason') }}</label>
        <textarea id="reason" name="reason" rows="8" required placeholder="{{ t('appeal.reason_placeholder') }}"></textarea>
      </div>

      <!-- 申诉证据区域 -->
      <div class="form-group">
        <h3 style="margin-bottom: 16px; font-size: 18px;">{{ t('appeal.appeal_evidence') }}</h3>
        <p class="text-secondary" style="margin-bottom: 20px; font-size: 14px;">
          {{ t('appeal.evidence_hint') }}
        </p>

        <!-- Google Drive 链接 -->
        <div style="margin-bottom: 24px;">
          <label for="evidence_drive_link" style="font-weight: 600; margin-bottom: 8px; display: block;">{{ t('appeal.drive_link') }}</label>
          <p class="text-light" style="font-size: 13px; margin-bottom: 12px;">
            {{ t('appeal.drive_link_hint') }}
          </p>
          <input type="url" id="evidence_drive_link" name="evidence_drive_link" placeholder="https://drive.google.com/drive/folders/..." style="margin-bottom: 16px;">

          <div style="margin-bottom: 16px;">
            <label for="evidence_description" style="font-size: 14px; font-weight: 500;">{{ t('appeal.evidence_description') }}</label>
            <textarea id="evidence_description" name="evidence_description" rows="3" placeholder="{{ t('appeal.evidence_desc_placeholder') }}"></textarea>
          </div>
        </div>
      </div>

      <div class="alert alert-warning">
        <div class="alert-content">
          <strong>{{ t('appeal.important_requirements') }}</strong>
          <ul style="margin: 8px 0 0; padding-left: 20px; font-size: 14px;">
            <li style="margin-bottom: 4px;">{{ t('appeal.req_identity') | safe }}</li>
            <li style="margin-bottom: 4px;">{{ t('appeal.req_permission') }}</li>
            <li style="margin-bottom: 4px;">{{ t('appeal.req_clarity') }}</li>
            <li>{{ t('appeal.req_privacy') }}</li>
          </ul>
        </div>
      </div>
    {% if config.TURNSTILE_SITE_KEY %}
    <div class="mt-3" style="display:flex; justify-content:center;">
      <div class="cf-turnstile" data-sitekey="{{ config.TURNSTILE_SITE_KEY }}" data-theme="auto" data-size="normal" data-callback="onTsOkAppeal"></div>
    </div>
    <script>
      let __tsRetryAppeal = false;
      let __tsAppealTs = 0;
      function onTsOkAppeal(token){
        const form = document.querySelector('form[action^="/appeal/"]');
        if(!form) return;
        let hidden = form.querySelector('input[name="cf-turnstile-response"]');
        if(!hidden){
          hidden = document.createElement('input');
          hidden.type = 'hidden';
          hidden.name = 'cf-turnstile-response';
          form.appendChild(hidden);
        }
        hidden.value = token || '';
        __tsAppealTs = Date.now();
      }
      window.addEventListener('load', () => {
        const form = document.querySelector('form[action^="/appeal/"]');
        if(!form) return;
        form.addEventListener('submit', (e) => {
          let h = form.querySelector('input[name="cf-turnstile-response"]');
          if(!h){ h = document.createElement('input'); h.type='hidden'; h.name='cf-turnstile-response'; h.value=''; form.appendChild(h); }
          const token = h.value.trim();
          const tooOld = __tsAppealTs && (Date.now() - __tsAppealTs > 90*1000);
          if(!token){ e.preventDefault(); alert('请先完成人机验证'); return false; }
          if(tooOld){ e.preventDefault(); try{ if(window.turnstile) turnstile.reset(); }catch(_){} alert('人机验证已过期，请重新勾选'); return false; }
        }, { capture: true });
      });
    </script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    {% endif %}
    <div class="mt-16">
      <button class="btn" type="submit">{{ t('appeal.submit_appeal') }}</button>
      <a class="btn secondary" href="/">{{ t('appeal.back') }}</a>
    </div>
  </form>
</div>
{% endblock %}
