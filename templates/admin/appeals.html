{% extends 'base.html' %}
{% block content %}
<div class="container">
  <div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
      <h2 style="margin: 0;">ç”³è¯‰ç®¡ç†</h2>
      <div class="btn-group">
        <a class="btn btn-ghost" href="/admin">è¿”å›ä»ªè¡¨ç›˜</a>
      </div>
    </div>
    
    <!-- çŠ¶æ€ç­›é€‰ -->
    <div class="btn-group" style="margin-bottom: 24px;">
      <a class="btn {{ 'btn-primary' if not request.args.get('status') else 'btn-secondary' }}" href="/admin/appeals">å…¨éƒ¨ç”³è¯‰</a>
      <a class="btn {{ 'btn-primary' if request.args.get('status') == 'pending' else 'btn-secondary' }}" href="/admin/appeals?status=pending">
        å¾…å¤„ç† 
        {% if appeals %}
          <span class="badge badge-warning">{{ appeals | selectattr('status', 'equalto', 'pending') | list | length }}</span>
        {% endif %}
      </a>
      <a class="btn {{ 'btn-primary' if request.args.get('status') == 'resolved' else 'btn-secondary' }}" href="/admin/appeals?status=resolved">å·²è§£å†³</a>
      <a class="btn {{ 'btn-primary' if request.args.get('status') == 'rejected' else 'btn-secondary' }}" href="/admin/appeals?status=rejected">å·²æ‹’ç»</a>
    </div>
  </div>

  {% if appeals and appeals|length > 0 %}
    <div class="cards-grid" style="grid-template-columns: 1fr;">
      {% for appeal in appeals %}
        <div class="card">
          <!-- ç”³è¯‰å¤´éƒ¨ä¿¡æ¯ -->
          <div class="card-header" style="border-bottom: 1px solid var(--border-light); padding-bottom: 16px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
              <div>
                <h3 style="margin: 0 0 8px; font-size: 18px;">ç”³è¯‰ #{{ appeal.id }}</h3>
                <div class="meta">
                  <span>æäº¤æ—¶é—´: {{ appeal.created_at.strftime('%Y-%m-%d %H:%M') }}</span> Â· 
                  <span>é’ˆå¯¹è®°å½•: <a href="/admin/submission/{{ appeal.submission_id }}">#{{ appeal.submission_id }}</a></span>
                </div>
              </div>
              <span class="badge {{ 'badge-warning' if appeal.status == 'pending' else ('badge-success' if appeal.status == 'resolved' else 'badge-danger') }}">
                {{ {'pending': 'å¾…å¤„ç†', 'resolved': 'å·²è§£å†³', 'rejected': 'å·²æ‹’ç»'}[appeal.status] or appeal.status }}
              </span>
            </div>
          </div>
          
          <!-- ç”³è¯‰å†…å®¹ -->
          <div style="margin-bottom: 20px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
              <div>
                <label style="font-weight: 600; font-size: 14px; color: var(--text-secondary);">ç”³è¯‰äººé‚®ç®±</label>
                <p style="margin: 4px 0 0;">{{ appeal.email }}</p>
              </div>
              <div>
                <label style="font-weight: 600; font-size: 14px; color: var(--text-secondary);">ç›¸å…³è®°å½•</label>
                <p style="margin: 4px 0 0;">
                  <a href="/s/{{ appeal.submission_id }}?source=admin" target="_blank">{{ appeal.submission.get_display_name(masked=False) }}</a>
                </p>
              </div>
            </div>
            
            <div style="margin-bottom: 16px;">
              <label style="font-weight: 600; font-size: 14px; color: var(--text-secondary);">ç”³è¯‰ç†ç”±</label>
              <div style="margin-top: 8px; padding: 16px; background: var(--surface-secondary); border-radius: 8px; white-space: pre-wrap;">{{ appeal.reason }}</div>
            </div>
            
            <!-- ç”³è¯‰è¯æ® -->
            {% if appeal.appeal_evidences %}
            <div style="margin-bottom: 16px;">
              <label style="font-weight: 600; font-size: 14px; color: var(--text-secondary); margin-bottom: 12px; display: block;">ç”³è¯‰è¯æ® (Google Drive)</label>
              <div style="border: 1px solid var(--border-light); border-radius: 8px; padding: 16px; background: var(--surface-secondary);">
                {% for evidence in appeal.appeal_evidences %}
                  <div style="margin-bottom: {% if not loop.last %}16px{% else %}0{% endif %};">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                      <span style="padding: 4px 8px; background: var(--nyu-purple-pale); color: var(--nyu-purple); border-radius: 6px; font-size: 12px; font-weight: 600;">
                        ğŸ“ Google Drive
                      </span>
                      <span style="font-size: 12px; color: var(--text-light);">
                        æäº¤æ—¶é—´: {{ evidence.created_at.strftime('%m-%d %H:%M') }}
                      </span>
                    </div>
                    
                    <div style="margin-bottom: 8px;">
                      <a href="{{ evidence.drive_link }}" target="_blank" rel="noopener noreferrer" 
                         style="color: var(--nyu-purple); text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="m9 18 6-6-6-6"/>
                        </svg>
                        æŸ¥çœ‹ Google Drive è¯æ®ææ–™
                      </a>
                    </div>
                    
                    {% if evidence.description %}
                      <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.4; background: white; padding: 8px; border-radius: 4px; border: 1px solid var(--border-light);">
                        <strong>è¯´æ˜ï¼š</strong>{{ evidence.description }}
                      </div>
                    {% endif %}
                    
                    <div style="margin-top: 8px; padding: 8px; background: var(--nyu-purple-pale); border-radius: 4px; font-size: 12px; color: var(--nyu-purple-dark);">
                      âš ï¸ <strong>æ³¨æ„ï¼š</strong>è¯·ç¡®è®¤é“¾æ¥å¯è®¿é—®ï¼Œå¹¶æ ¸å®æ˜¯å¦åŒ…å«èº«ä»½éªŒè¯ææ–™
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
            {% endif %}
            
            <!-- ç®¡ç†å‘˜å¤‡æ³¨ -->
            {% if appeal.admin_notes %}
            <div style="margin-bottom: 16px;">
              <label style="font-weight: 600; font-size: 14px; color: var(--text-secondary);">ç®¡ç†å‘˜å¤‡æ³¨</label>
              <div style="margin-top: 8px; padding: 16px; background: var(--nyu-purple-pale); border-radius: 8px;">{{ appeal.admin_notes }}</div>
            </div>
            {% endif %}
          </div>
          
          <!-- æ“ä½œåŒºåŸŸ -->
          {% if appeal.status == 'pending' %}
          <div style="border-top: 1px solid var(--border-light); padding-top: 20px;">
            <form action="/admin/appeal/{{ appeal.id }}/action" method="post">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
              
              <div class="form-group" style="margin-bottom: 16px;">
                <label for="note_{{ appeal.id }}">å¤„ç†å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
                <textarea name="note" id="note_{{ appeal.id }}" rows="3" placeholder="è¯·è®°å½•å¤„ç†ç»“æœã€åŸå› æˆ–å…¶ä»–ç›¸å…³ä¿¡æ¯"></textarea>
              </div>
              
              <div class="btn-group">
                <button class="btn btn-primary" name="action" value="resolve" type="submit">
                  åŒæ„ç”³è¯‰
                </button>
                <button class="btn btn-secondary" name="action" value="reject" type="submit">
                  æ‹’ç»ç”³è¯‰
                </button>
                <button class="btn btn-ghost" name="action" value="delete" type="submit" 
                        onclick="return confirm('ç¡®å®šåˆ é™¤è¯¥ç”³è¯‰ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')" style="color: #DC2626;">
                  åˆ é™¤ç”³è¯‰
                </button>
              </div>
            </form>
          </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="card">
      <div style="text-align: center; padding: 48px 24px;">
        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“</div>
        <h3 style="margin: 0 0 8px;">æš‚æ— ç”³è¯‰è®°å½•</h3>
        <p class="text-secondary">å½“ç”¨æˆ·æäº¤ç”³è¯‰æ—¶ï¼Œç›¸å…³ä¿¡æ¯ä¼šåœ¨è¿™é‡Œæ˜¾ç¤º</p>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}
