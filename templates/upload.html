{% extends 'base.html' %}
{% block content %}
<style>
  .file-upload-container {
    margin-top: 12px;
  }
  
  .file-drop-zone {
    border: 2px dashed var(--border-light);
    border-radius: 12px;
    padding: 32px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: var(--surface-secondary);
  }
  
  .file-drop-zone:hover {
    border-color: var(--nyu-purple);
    background: var(--nyu-purple-pale);
  }
  
  .file-drop-zone.dragover {
    border-color: var(--nyu-purple);
    background: var(--nyu-purple-pale);
    transform: scale(1.02);
  }
  
  .files-list {
    margin-top: 16px;
    display: none;
  }
  
  .files-list.has-files {
    display: block;
  }
  
  .file-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    background: var(--surface-secondary);
    border-radius: 8px;
    margin-bottom: 8px;
    animation: slideIn 0.3s ease;
  }
  
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .file-info {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
  }
  
  .file-icon {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
  }
  
  .file-icon.image { background: #E3F2FD; color: #1976D2; }
  .file-icon.doc { background: #FFF3E0; color: #F57C00; }
  .file-icon.video { background: #F3E5F5; color: #7B1FA2; }
  
  .file-details {
    flex: 1;
  }
  
  .file-name {
    font-weight: 500;
    font-size: 14px;
    color: var(--text-primary);
    margin-bottom: 2px;
  }
  
  .file-size {
    font-size: 12px;
    color: var(--text-light);
  }
  
  .file-remove {
    padding: 6px 12px;
    background: transparent;
    border: 1px solid var(--border-light);
    border-radius: 6px;
    color: var(--text-secondary);
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .file-remove:hover {
    background: #FFE6E9;
    border-color: #DC2626;
    color: #DC2626;
  }
  
  .add-more-btn {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--nyu-purple);
    background: transparent;
    color: var(--nyu-purple);
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-top: 12px;
  }
  
  .add-more-btn:hover {
    background: var(--nyu-purple);
    color: white;
  }
  
  /* ç®€çº¦ä¼ä¸šçº§æ ‡ç­¾æ ·å¼ */
  .tag-minimal-blue:has(input:checked) {
    border-color: #3B82F6 !important;
    background: #EFF6FF !important;
  }
  
  .tag-minimal-blue input:checked + span {
    color: #1D4ED8 !important;
    font-weight: 500;
  }
  
  .tag-minimal-red:has(input:checked) {
    border-color: #EF4444 !important;
    background: #FEF2F2 !important;
  }
  
  .tag-minimal-red input:checked + span {
    color: #DC2626 !important;
    font-weight: 500;
  }
  
  /* æäº¤æŒ‰é’®åŠ¨ç”» */
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  
  .btn-primary:disabled {
    cursor: not-allowed;
    transform: none !important;
  }

  /* è¡¨å•éªŒè¯æ ·å¼ - åªåœ¨æäº¤åæ˜¾ç¤º */
  .form-submitted .privacy-checkbox.required:has(input:not(:checked)) {
    border-color: #DC2626 !important;
    background: #FEF2F2 !important;
  }
  
  .form-submitted .privacy-checkbox.required:has(input:not(:checked)) div {
    color: #DC2626 !important;
  }

  /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
  @media (max-width: 768px) {
    .container-narrow {
      padding: 0 16px;
    }
    
    .card {
      padding: 20px 16px;
      margin-bottom: 16px;
    }
    
    /* æ ‡ç­¾ç½‘æ ¼ä¼˜åŒ– */
    .tag-grid {
      grid-template-columns: repeat(2, 1fr) !important;
      gap: 8px !important;
    }
    
    .tag-minimal-blue, .tag-minimal-red {
      padding: 10px 12px !important;
      font-size: 13px !important;
    }
    
    /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸä¼˜åŒ– */
    .file-drop-zone {
      padding: 24px 16px !important;
    }
    
    .file-drop-zone p:first-of-type {
      font-size: 14px !important;
      margin-bottom: 4px !important;
    }
    
    .file-drop-zone p:last-of-type {
      font-size: 12px !important;
    }
    
    /* æ–‡ä»¶åˆ—è¡¨ä¼˜åŒ– */
    .file-item {
      padding: 12px !important;
      flex-direction: column !important;
      align-items: stretch !important;
    }
    
    .file-info {
      margin-bottom: 8px;
    }
    
    .file-remove {
      align-self: flex-end;
      padding: 6px 12px;
      font-size: 12px;
    }
    
    /* è¡¨å•å­—æ®µä¼˜åŒ– */
    input[type="text"], 
    input[type="email"], 
    textarea {
      padding: 12px 14px !important;
      font-size: 16px !important; /* é˜²æ­¢iOSç¼©æ”¾ */
    }
    
    textarea {
      min-height: 120px !important;
    }
    
    /* æŒ‰é’®ä¼˜åŒ– */
    .btn {
      padding: 12px 24px !important;
      font-size: 15px !important;
      min-height: 44px; /* è§¦æ‘¸å‹å¥½ */
    }
    
    .add-more-btn {
      padding: 12px !important;
      font-size: 13px !important;
      min-height: 44px;
    }
    
    /* æäº¤æŒ‰é’®ç»„ */
    .submit-buttons {
      flex-direction: column !important;
      gap: 12px !important;
    }
    
    .submit-buttons .btn {
      width: 100% !important;
    }
    
    /* éšç§è®¾ç½®ä¼˜åŒ– */
    .privacy-checkbox {
      padding: 14px !important;
    }
    
    .privacy-checkbox div {
      font-size: 14px !important;
      line-height: 1.4 !important;
    }
    
    /* äººæœºéªŒè¯å®¹å™¨ */
    #ts-container {
      transform: scale(0.9);
      transform-origin: center;
    }
    
    /* å‡å°‘é—´è· */
    .form-group {
      margin-bottom: 20px !important;
    }
    
    .alert {
      padding: 14px 16px !important;
      margin: 16px 0 !important;
    }
    
    .section-title {
      font-size: 24px !important;
    }
    
    .section-subtitle {
      font-size: 16px !important;
    }
  }
  
  @media (max-width: 480px) {
    .card {
      padding: 16px 12px;
    }
    
    .tag-minimal-blue, .tag-minimal-red {
      padding: 8px 10px !important;
      font-size: 12px !important;
    }
    
    .file-drop-zone {
      padding: 20px 12px !important;
    }
    
    .section-title {
      font-size: 22px !important;
    }
    
    .section-subtitle {
      font-size: 15px !important;
    }
    
    input[type="text"], 
    input[type="email"] {
      padding: 12px !important;
    }
    
    #ts-container {
      transform: scale(0.85);
    }
  }
</style>

<script>
  // å­˜å‚¨æ‰€æœ‰é€‰æ‹©çš„æ–‡ä»¶åŠå…¶æè¿°
  const selectedFiles = {
    image: [],
    doc: [],
    chat: []
  };
  
  // å­˜å‚¨æ¯ä¸ªæ–‡ä»¶çš„æè¿°
  const fileDescriptions = {
    image: [],
    doc: [],
    chat: []
  };
  
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }
  
  function getFileIcon(type) {
    if (type === 'image') return 'ğŸ–¼ï¸';
    if (type === 'doc') return 'ğŸ“„';
    if (type === 'chat') return 'ğŸ¬';
    return 'ğŸ“';
  }

  function getFileType(file) {
    const type = file.type.toLowerCase();
    const name = file.name.toLowerCase();
    
    if (type.startsWith('image/')) return 'image';
    if (type.startsWith('video/')) return 'chat';
    if (type === 'application/pdf' || name.endsWith('.pdf')) return 'doc';
    if (type === 'text/plain' || name.endsWith('.txt')) return 'doc';
    if (type === 'application/msword' || name.endsWith('.doc')) return 'doc';
    if (type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || name.endsWith('.docx')) return 'doc';
    
    return 'doc'; // é»˜è®¤ä¸ºæ–‡æ¡£ç±»å‹
  }

  function handleUnifiedFileSelect(input) {
    const files = Array.from(input.files);
    
    // æŒ‰æ–‡ä»¶ç±»å‹åˆ†ç»„
    const filesByType = {
      image: [],
      doc: [],
      chat: []
    };
    
    files.forEach(file => {
      const type = getFileType(file);
      filesByType[type].push(file);
    });
    
    // å¯¹æ¯ç§ç±»å‹çš„æ–‡ä»¶åˆ†åˆ«å¤„ç†ï¼Œåº”ç”¨åŸæœ‰çš„é™åˆ¶é€»è¾‘
    for (const [type, typeFiles] of Object.entries(filesByType)) {
      if (typeFiles.length > 0) {
        handleFileSelect(typeFiles, type);
      }
    }
    
    // æ¸…ç©ºè¾“å…¥æ¡†ä»¥ä¾¿ä¸‹æ¬¡é€‰æ‹©
    input.value = '';
  }
  
  function handleFileSelect(input, type) {
    const files = input.files ? Array.from(input.files) : input;
    
    // æ–‡ä»¶æ•°é‡å’Œæ€»å¤§å°é™åˆ¶
    if (type === 'image') {
      const maxImages = 10; // {{ config.MAX_IMAGES_PER_SUBMISSION }}
      const currentCount = selectedFiles[type].length;
      const newFilesCount = files.length;
      
      if (currentCount + newFilesCount > maxImages) {
        alert(`æœ€å¤šåªèƒ½ä¸Šä¼ ${maxImages}å¼ å›¾ç‰‡ï¼Œå½“å‰å·²é€‰æ‹©${currentCount}å¼ ï¼Œæ‚¨å°è¯•æ·»åŠ ${newFilesCount}å¼ ã€‚`);
        return;
      }
      
      // æ£€æŸ¥å›¾ç‰‡æ€»å¤§å°é™åˆ¶
      const maxTotalSize = 20971520; // {{ config.MAX_IMAGES_TOTAL_SIZE }} 20MB
      let currentTotalSize = selectedFiles[type].reduce((sum, file) => sum + file.size, 0);
      let newFilesTotalSize = files.reduce((sum, file) => sum + file.size, 0);
      
      if (currentTotalSize + newFilesTotalSize > maxTotalSize) {
        const maxSizeMB = Math.round(maxTotalSize / (1024 * 1024));
        const currentSizeMB = Math.round(currentTotalSize / (1024 * 1024) * 100) / 100;
        const newSizeMB = Math.round(newFilesTotalSize / (1024 * 1024) * 100) / 100;
        alert(`å›¾ç‰‡æ€»å¤§å°ä¸èƒ½è¶…è¿‡${maxSizeMB}MBï¼Œå½“å‰å·²é€‰æ‹©${currentSizeMB}MBï¼Œæ‚¨å°è¯•æ·»åŠ ${newSizeMB}MBã€‚`);
        return;
      }
    }
    
    if (type === 'doc') {
      const maxDocs = 5; // {{ config.MAX_DOCS_PER_SUBMISSION }}
      const currentCount = selectedFiles[type].length;
      const newFilesCount = files.length;
      
      if (currentCount + newFilesCount > maxDocs) {
        alert(`æœ€å¤šåªèƒ½ä¸Šä¼ ${maxDocs}ä¸ªæ–‡æ¡£ï¼Œå½“å‰å·²é€‰æ‹©${currentCount}ä¸ªï¼Œæ‚¨å°è¯•æ·»åŠ ${newFilesCount}ä¸ªã€‚`);
        return;
      }
      
      // æ£€æŸ¥æ–‡æ¡£æ€»å¤§å°é™åˆ¶
      const maxTotalSize = 20971520; // {{ config.MAX_DOCS_TOTAL_SIZE }} 20MB
      let currentTotalSize = selectedFiles[type].reduce((sum, file) => sum + file.size, 0);
      let newFilesTotalSize = files.reduce((sum, file) => sum + file.size, 0);
      
      if (currentTotalSize + newFilesTotalSize > maxTotalSize) {
        const maxSizeMB = Math.round(maxTotalSize / (1024 * 1024));
        const currentSizeMB = Math.round(currentTotalSize / (1024 * 1024) * 100) / 100;
        const newSizeMB = Math.round(newFilesTotalSize / (1024 * 1024) * 100) / 100;
        alert(`æ–‡æ¡£æ€»å¤§å°ä¸èƒ½è¶…è¿‡${maxSizeMB}MBï¼Œå½“å‰å·²é€‰æ‹©${currentSizeMB}MBï¼Œæ‚¨å°è¯•æ·»åŠ ${newSizeMB}MBã€‚`);
        return;
      }
    }
    
    if (type === 'chat') {
      const maxVideos = 3; // {{ config.MAX_VIDEOS_PER_SUBMISSION }}
      const currentCount = selectedFiles[type].length;
      const newFilesCount = files.length;
      
      if (currentCount + newFilesCount > maxVideos) {
        alert(`æœ€å¤šåªèƒ½ä¸Šä¼ ${maxVideos}ä¸ªè§†é¢‘ï¼Œå½“å‰å·²é€‰æ‹©${currentCount}ä¸ªï¼Œæ‚¨å°è¯•æ·»åŠ ${newFilesCount}ä¸ªã€‚`);
        return;
      }
      
      // æ£€æŸ¥è§†é¢‘æ€»å¤§å°é™åˆ¶
      const maxTotalSize = 20971520; // {{ config.MAX_VIDEOS_TOTAL_SIZE }} 20MB
      let currentTotalSize = selectedFiles[type].reduce((sum, file) => sum + file.size, 0);
      let newFilesTotalSize = files.reduce((sum, file) => sum + file.size, 0);
      
      if (currentTotalSize + newFilesTotalSize > maxTotalSize) {
        const maxSizeMB = Math.round(maxTotalSize / (1024 * 1024));
        const currentSizeMB = Math.round(currentTotalSize / (1024 * 1024) * 100) / 100;
        const newSizeMB = Math.round(newFilesTotalSize / (1024 * 1024) * 100) / 100;
        alert(`è§†é¢‘æ€»å¤§å°ä¸èƒ½è¶…è¿‡${maxSizeMB}MBï¼Œå½“å‰å·²é€‰æ‹©${currentSizeMB}MBï¼Œæ‚¨å°è¯•æ·»åŠ ${newSizeMB}MBã€‚`);
        return;
      }
    }
    
    // æ·»åŠ æ–°æ–‡ä»¶åˆ°åˆ—è¡¨ï¼ˆé¿å…é‡å¤ï¼‰
    files.forEach(file => {
      // ä¸ºæ–‡ä»¶æ·»åŠ å”¯ä¸€æ ‡è¯†ç¬¦
      const fileId = `${file.name}_${file.size}_${file.lastModified}_${Date.now()}`;
      const exists = selectedFiles[type].some(f => 
        f.name === file.name && f.size === file.size && f.lastModified === file.lastModified
      );
      if (!exists) {
        file._id = fileId; // æ·»åŠ å”¯ä¸€ID
        selectedFiles[type].push(file);
        fileDescriptions[type].push(''); // æ·»åŠ ç©ºæè¿°
      }
    });
    
    // æ›´æ–°æ˜¾ç¤º
    updateFilesList(type);
  }
  
  function removeFile(type, index) {
    selectedFiles[type].splice(index, 1);
    fileDescriptions[type].splice(index, 1);
    
    // æ¸…ç©ºå¯¹åº”çš„inputå…ƒç´ ï¼Œå…è®¸é‡æ–°é€‰æ‹©ç›¸åŒæ–‡ä»¶
    const inputMap = {
      'image': 'image_evidences',
      'doc': 'doc_evidences', 
      'chat': 'chat_recordings'
    };
    const inputElement = document.getElementById(inputMap[type]);
    if (inputElement) {
      inputElement.value = '';
    }
    
    updateFilesList(type);
  }
  
  function updateFileDescription(type, index, description) {
    fileDescriptions[type][index] = description;
  }
  
  function updateFilesList(type) {
    // æ›´æ–°ç»Ÿä¸€çš„æ–‡ä»¶åˆ—è¡¨
    updateUnifiedFilesList();
  }

  function updateUnifiedFilesList() {
    const listContainer = document.getElementById('unified-files-list');
    const allFiles = [];
    
    // æ”¶é›†æ‰€æœ‰æ–‡ä»¶
    Object.keys(selectedFiles).forEach(type => {
      selectedFiles[type].forEach((file, index) => {
        allFiles.push({
          file,
          type,
          index,
          description: fileDescriptions[type][index] || ''
        });
      });
    });
    
    if (allFiles.length === 0) {
      listContainer.classList.remove('has-files');
      listContainer.innerHTML = '';
      return;
    }
    
    listContainer.classList.add('has-files');
    
    let html = '';
    allFiles.forEach((item) => {
      const { file, type, index } = item;
      const isVideo = file.type.startsWith('video/');
      const iconClass = isVideo ? 'video' : type;
      const icon = getFileIcon(type);
      
      html += `
        <div class="file-item" style="flex-direction: column; align-items: stretch;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
            <div class="file-info">
              <div class="file-icon ${iconClass}">${icon}</div>
              <div class="file-details">
                <div class="file-name">${file.name}</div>
                <div class="file-size">${formatFileSize(file.size)}</div>
              </div>
            </div>
            <button type="button" class="file-remove" onclick="removeFile('${type}', ${index})">
              ç§»é™¤
            </button>
          </div>
          <div style="margin-top: 8px;">
            <label style="font-size: 13px; color: var(--text-secondary); display: block; margin-bottom: 4px;">
              <span style="color: #DC2626;">*</span> è¯æ®è¯´æ˜ï¼ˆå¿…å¡«ï¼‰
            </label>
            <textarea 
              placeholder="è¯·ç®€è¦è¯´æ˜æ­¤è¯æ®çš„å†…å®¹å’Œç›¸å…³æ€§..." 
              style="width: 100%; padding: 8px; border: 1px solid var(--border-light); border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"
              onchange="updateFileDescription('${type}', ${index}, this.value)"
              required
            >${fileDescriptions[type][index] || ''}</textarea>
          </div>
        </div>
      `;
    });
    
    html += `
      <div style="display:flex; align-items:center; gap:12px; margin-top: 16px;">
        <button type="button" class="add-more-btn" onclick="document.getElementById('all_evidences').click()">
          + æ·»åŠ æ›´å¤šæ–‡ä»¶
        </button>
        <div class="meta" style="font-size:12px; color: var(--text-light);">å·²é€‰ ${allFiles.length} ä¸ªæ–‡ä»¶</div>
      </div>
    `;
    
    listContainer.innerHTML = html;
  }

  // ä¸Šä¼ è¿›åº¦ & ç¦ç”¨æäº¤
  let uploading = false;
  function anyFilesSelected(){
    return selectedFiles.image.length + selectedFiles.doc.length + selectedFiles.chat.length > 0;
  }
  function toggleSubmit(disabled, text){
    const btn = document.querySelector('button.btn.btn-primary[type="submit"]');
    if(!btn) return;
    btn.disabled = !!disabled;
    if(disabled){
      btn.dataset._text = btn.textContent;
      btn.innerHTML = `<span class="spinner" style="width:16px;height:16px;border:2px solid #fff;border-right-color:transparent;border-radius:50%;display:inline-block;vertical-align:middle;animation:spin 0.8s linear infinite;margin-right:8px;"></span>${text||'æ­£åœ¨ä¸Šä¼ ...'}`;
    }else{
      btn.textContent = btn.dataset._text || 'æäº¤è¯„ä»·';
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    // æ³¨æ„ï¼šä¸»è¦çš„è¡¨å•æäº¤å¤„ç†åœ¨ä¸‹æ–¹ç»Ÿä¸€å¤„ç†ï¼Œè¿™é‡Œåªåšé¢„æ£€æŸ¥
  });

  // ä¿é™©èµ·è§ï¼Œä½¿ç”¨è„šæœ¬æ–¹å¼ç¡®ä¿æ–‡ä»¶é€‰æ‹©äº‹ä»¶å·²ç»‘å®š
  document.addEventListener('DOMContentLoaded', function(){
    const allInput = document.getElementById('all_evidences');
    if(allInput){
      allInput.addEventListener('change', function(e){
        try {
          handleUnifiedFileSelect(e.target);
        } catch(err){
          console.error('handleUnifiedFileSelect error:', err);
          alert('é€‰æ‹©æ–‡ä»¶å¤±è´¥ï¼š' + (err && err.message ? err.message : err));
        }
      });
    }
  });

  // ä½¿ç”¨åŸç”ŸXHRåˆ†æ‰¹ä¸Šä¼ ä¸å¯è¡Œï¼ˆéœ€åç«¯æ¥å£æ”¯æŒï¼‰ï¼Œå› æ­¤è¿™é‡Œä»…åšè¡¨å•æäº¤æ—¶çš„ä¸Šä¼ æŒ‡ç¤º
  // è‹¥æœªæ¥æ”¹ä¸ºAJAXåˆ†ç‰‡ä¸Šä¼ ï¼Œå¯åœ¨æ­¤æ¥å…¥xhr.upload.onprogressæ¥å®æ—¶è¿›åº¦
  
  // æ‹–æ‹½åŠŸèƒ½
  document.addEventListener('DOMContentLoaded', function() {
    const dropZones = document.querySelectorAll('.file-drop-zone');
    
    dropZones.forEach(zone => {
      zone.addEventListener('dragover', (e) => {
        e.preventDefault();
        zone.classList.add('dragover');
      });
      
      zone.addEventListener('dragleave', () => {
        zone.classList.remove('dragover');
      });
      
      zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.classList.remove('dragover');
        const input = zone.parentElement.querySelector('input[type="file"]');
        const accept = input ? (input.getAttribute('accept') || '') : '';
        const files = Array.from((e.dataTransfer && e.dataTransfer.files) ? e.dataTransfer.files : []);
        if(files.length === 0) return;
        const validFiles = files.filter(file => {
          if (!accept) return true;
          return (
            (accept.includes('image/*') && file.type.startsWith('image/')) ||
            (accept.includes('video/*') && file.type.startsWith('video/')) ||
            (accept.includes('.pdf') && file.name.endsWith('.pdf')) ||
            (accept.includes('.txt') && file.name.endsWith('.txt')) ||
            (accept.includes('.doc') && (file.name.endsWith('.doc') || file.name.endsWith('.docx')))
          );
        });
        if (validFiles.length === 0) return;
        try{
          handleUnifiedFileSelect({ files: validFiles });
        }catch(err){
          console.error('drop->handleUnifiedFileSelect error:', err);
          alert('æ·»åŠ æ–‡ä»¶å¤±è´¥ï¼š' + (err && err.message ? err.message : err));
        }
      });
    });
  });
  
  // ç»‘å®šå®¡æ ¸ç»“æœæŒ‰é’®äº‹ä»¶
  function bindModerationButtonEvents(moderationResult) {
    const acceptBtn = document.querySelector('.accept-suggestion-btn');
    const editBtn = document.querySelector('.edit-manual-btn');
    
    // æ·»åŠ ä¿®æ”¹æç¤ºæ¶ˆæ¯
    addModerationTip();
    
    if (acceptBtn) {
      acceptBtn.addEventListener('click', function() {
        const descriptionTextarea = document.getElementById('description');
        descriptionTextarea.value = moderationResult.safe_suggestion;
        
        // ç§»é™¤å®¡æ ¸ç»“æœæ˜¾ç¤º
        const moderationDisplay = document.querySelector('.moderation-result-display');
        if (moderationDisplay) moderationDisplay.remove();
        
        // ç§»é™¤æç¤ºæ¶ˆæ¯
        removeModerationTip();
        
        // æ˜¾ç¤ºåŸå§‹æè¿°åŒºåŸŸ
        const descriptionField = descriptionTextarea.closest('.form-group');
        descriptionField.style.display = 'block';
        
        // é‡ç½®TurnstileçŠ¶æ€
        resetTurnstileAfterModeration();
      });
    }
    
    if (editBtn) {
      editBtn.addEventListener('click', function() {
        // ç§»é™¤å®¡æ ¸ç»“æœæ˜¾ç¤º
        const moderationDisplay = document.querySelector('.moderation-result-display');
        if (moderationDisplay) moderationDisplay.remove();
        
        // ç§»é™¤æç¤ºæ¶ˆæ¯
        removeModerationTip();
        
        // æ˜¾ç¤ºåŸå§‹æè¿°åŒºåŸŸè®©ç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹
        const descriptionField = document.getElementById('description').closest('.form-group');
        descriptionField.style.display = 'block';
        
        // èšç„¦åˆ°æ–‡æœ¬åŸŸ
        document.getElementById('description').focus();
        
        // é‡ç½®TurnstileçŠ¶æ€
        resetTurnstileAfterModeration();
      });
    }
  }
  
  // æ·»åŠ å®¡æ ¸å¤±è´¥æç¤ºæ¶ˆæ¯
  function addModerationTip() {
    const submitButtonContainer = document.querySelector('.submit-buttons');
    if (submitButtonContainer) {
      // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§æç¤º
      removeModerationTip();
      
      const tipHTML = `
        <div class="moderation-failed-tip" style="
          margin-top: 16px;
          padding: 12px 16px;
          background: linear-gradient(135deg, rgba(239, 68, 68, 0.03) 0%, rgba(239, 68, 68, 0.06) 100%);
          border: 1px solid rgba(239, 68, 68, 0.12);
          border-radius: 12px;
          text-align: center;
          color: var(--text-secondary);
          font-size: 14px;
          line-height: 1.4;
        ">
          âš ï¸ å®¡æ ¸ä¸é€šè¿‡ï¼Œè¯·ä¿®æ”¹åé‡æ–°æäº¤
        </div>
      `;
      submitButtonContainer.insertAdjacentHTML('afterend', tipHTML);
    }
  }
  
  // ç§»é™¤å®¡æ ¸å¤±è´¥æç¤ºæ¶ˆæ¯
  function removeModerationTip() {
    const existingTip = document.querySelector('.moderation-failed-tip');
    if (existingTip) {
      existingTip.remove();
    }
  }
  
  // é‡ç½®TurnstileéªŒè¯çŠ¶æ€
  function resetTurnstileAfterModeration() {
    console.log('ğŸ” [DEBUG] Resetting Turnstile state after moderation success');
    
    // ç›´æ¥é‡ç½®æŒ‰é’®çŠ¶æ€ï¼ˆä¸ä¾èµ–turnstileManagerï¼‰
    const submitBtn = document.querySelector('button[type="submit"]');
    if (submitBtn) {
      submitBtn.textContent = 'æäº¤è¯„ä»·';
      submitBtn.style.opacity = '1';
      submitBtn.style.cursor = 'pointer';
      submitBtn.disabled = false;
      console.log('ğŸ” [DEBUG] Submit button reset to normal state');
    }
    
    if (window.turnstileManager) {
      // é‡ç½®TurnstileçŠ¶æ€ä¸ºå¯æäº¤
      window.turnstileManager.isReady = true;
      
      // æ›´æ–°æäº¤æŒ‰é’®çŠ¶æ€ï¼ˆé€šè¿‡turnstileManagerï¼‰
      if (window.turnstileManager.setSubmitEnabled) {
        window.turnstileManager.setSubmitEnabled(true);
      }
      
      // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
      const statusEl = document.getElementById('ts-status');
      if (statusEl) {
        statusEl.innerHTML = 'âœ… äººæœºéªŒè¯å·²å®Œæˆï¼Œå¯ä»¥æäº¤';
      }
      
      console.log('ğŸ” [DEBUG] TurnstileManager state reset completed');
    }
    
    // å»¶è¿Ÿå†æ¬¡ç¡®è®¤çŠ¶æ€ï¼ˆé˜²æ­¢å¼‚æ­¥è¦†ç›–ï¼‰
    setTimeout(() => {
      const submitBtn = document.querySelector('button[type="submit"]');
      if (submitBtn && submitBtn.textContent.includes('ç­‰å¾…éªŒè¯')) {
        console.log('ğŸ” [DEBUG] Button still showing wait state, forcing reset');
        submitBtn.textContent = 'æäº¤è¯„ä»·';
        submitBtn.style.opacity = '1';
        submitBtn.style.cursor = 'pointer';
        submitBtn.disabled = false;
      }
    }, 100);
  }

  // åˆ›å»ºå®¡æ ¸ç»“æœæ˜¾ç¤ºåŒºåŸŸçš„å‡½æ•°
  function createModerationResultDisplay(moderationResult) {
    // ç§»é™¤ç°æœ‰çš„å®¡æ ¸ç»“æœæ˜¾ç¤ºï¼ˆå¦‚æœæœ‰ï¼‰
    const existingResult = document.querySelector('.moderation-result-display');
    if (existingResult) {
      existingResult.remove();
    }
    
    // éšè—æè¿°å­—æ®µ
    const descriptionField = document.getElementById('description').closest('.form-group');
    descriptionField.style.display = 'none';
    
    // åˆ›å»ºç®€çº¦ç°ä»£çš„å®¡æ ¸ç»“æœHTML
    const resultHTML = `
      <div class="moderation-result-display" style="
        margin: 24px 0; 
        padding: 20px; 
        background: linear-gradient(135deg, rgba(255, 107, 53, 0.03) 0%, rgba(255, 107, 53, 0.06) 100%);
        border: 1px solid rgba(255, 107, 53, 0.12);
        border-radius: 16px;
        position: relative;
        overflow: hidden;
      ">
        <div style="
          position: absolute; 
          top: 0; 
          left: 0; 
          right: 0; 
          height: 3px; 
          background: linear-gradient(90deg, var(--nyu-accent) 0%, rgba(255, 107, 53, 0.6) 100%);
        "></div>
        
        <div style="display: flex; align-items: flex-start; gap: 16px; margin-bottom: 16px;">
          <div style="
            width: 40px; 
            height: 40px; 
            background: linear-gradient(135deg, var(--nyu-accent) 0%, rgba(255, 107, 53, 0.8) 100%);
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.2);
          ">
            <span style="font-size: 18px;">âš ï¸</span>
          </div>
          <div style="flex: 1;">
            <h3 style="
              margin: 0 0 8px 0; 
              font-size: 18px; 
              font-weight: 600; 
              color: var(--text-primary);
              line-height: 1.3;
            ">å†…å®¹éœ€è¦è°ƒæ•´</h3>
            <p style="
              margin: 0; 
              color: var(--text-secondary); 
              font-size: 15px; 
              line-height: 1.5;
            ">${moderationResult.client_notice || 'ä¸ºäº†æ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œè¯·æŒ‰ä»¥ä¸‹å»ºè®®ä¿®æ”¹å†…å®¹'}</p>
          </div>
        </div>

        ${moderationResult.safe_suggestion ? `
        <div style="
          background: rgba(255, 255, 255, 0.7);
          backdrop-filter: blur(10px);
          border: 1px solid rgba(87, 6, 140, 0.08);
          border-radius: 12px; 
          padding: 16px; 
          margin-bottom: 16px;
        ">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
            <div style="
              width: 24px; 
              height: 24px; 
              background: linear-gradient(135deg, var(--nyu-purple) 0%, rgba(87, 6, 140, 0.8) 100%);
              border-radius: 6px; 
              display: flex; 
              align-items: center; 
              justify-content: center;
            ">
              <span style="color: white; font-size: 12px; font-weight: bold;">AI</span>
            </div>
            <span style="font-size: 14px; font-weight: 600; color: var(--nyu-purple);">å»ºè®®æ”¹å†™</span>
          </div>
          <p style="
            margin: 0; 
            line-height: 1.6; 
            color: var(--text-primary); 
            font-size: 15px;
            padding: 8px 0;
          ">"${moderationResult.safe_suggestion}"</p>
        </div>
        ` : ''}
        
        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
          ${moderationResult.safe_suggestion ? `
          <button type="button" class="accept-suggestion-btn" style="
            padding: 10px 20px; 
            background: linear-gradient(135deg, var(--nyu-purple) 0%, var(--nyu-purple-dark) 100%);
            color: white; 
            border: none; 
            border-radius: 10px; 
            font-weight: 600; 
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(87, 6, 140, 0.2);
          " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 16px rgba(87, 6, 140, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(87, 6, 140, 0.2)'">
            é‡‡ç”¨å»ºè®®
          </button>
          ` : ''}
          <button type="button" class="edit-manual-btn" style="
            padding: 10px 20px; 
            background: rgba(255, 255, 255, 0.9);
            color: var(--text-secondary); 
            border: 1px solid var(--border-light); 
            border-radius: 10px; 
            font-weight: 600; 
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
          " onmouseover="this.style.background='var(--surface-primary)'; this.style.color='var(--nyu-purple)'; this.style.borderColor='var(--nyu-purple-pale)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.9)'; this.style.color='var(--text-secondary)'; this.style.borderColor='var(--border-light)'">
            æ‰‹åŠ¨ä¿®æ”¹
          </button>
        </div>
        
        <!-- æ“ä½œæç¤ºç§»åˆ°æŒ‰é’®ä¸‹æ–¹ -->
      </div>
    `;
    
    // ç®€å•æ’å…¥å®¡æ ¸ç»“æœ
    descriptionField.insertAdjacentHTML('beforebegin', resultHTML);
    
    // ç»‘å®šæŒ‰é’®äº‹ä»¶
    bindModerationButtonEvents(moderationResult);
  }
  // ä¿®æ”¹è¡¨å•æäº¤ä»¥åŒ…å«æ‰€æœ‰æ–‡ä»¶
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      // ğŸ” [DEBUG] Form submission started
      console.log('ğŸ” [DEBUG] Form submission started');
      
      // é¦–å…ˆæ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¿˜åœ¨ä¸Šä¼ 
      if(uploading){
        alert('æ–‡ä»¶ä»åœ¨ä¸Šä¼ ï¼Œè¯·ç¨å€™å®Œæˆåå†æäº¤');
        return;
      }
      
      // Add form-submitted class for validation styling
      form.classList.add('form-submitted');
      
      // ä½¿ç”¨ç»Ÿä¸€çš„ Turnstile éªŒè¯
      if (window.turnstileValidation) {
        const turnstileResult = window.turnstileValidation();
        if (!turnstileResult.valid) {
          if (turnstileResult.reason === 'legal_agreement') {
            alert('è¯·å…ˆé˜…è¯»å¹¶åŒæ„æœåŠ¡æ¡æ¬¾å’Œéšç§æ”¿ç­–');
            document.querySelector('input[name="legal_agreement"]').focus();
          } else if (turnstileResult.reason === 'not_completed') {
            alert('è¯·å…ˆå®ŒæˆäººæœºéªŒè¯');
          } else if (turnstileResult.reason === 'expired') {
            alert('éªŒè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°éªŒè¯');
          }
          return;
        }
      } else {
        // å¤‡ç”¨éªŒè¯ï¼ˆå¦‚æœ Turnstile ç®¡ç†å™¨æœªåˆå§‹åŒ–ï¼‰
        const legalAgreement = document.querySelector('input[name="legal_agreement"]');
        if (!legalAgreement.checked) {
          alert('è¯·å…ˆé˜…è¯»å¹¶åŒæ„æœåŠ¡æ¡æ¬¾å’Œéšç§æ”¿ç­–');
          legalAgreement.focus();
          return;
        }
      }
      
      // è¯æ®æ–‡ä»¶ç°åœ¨ä¸ºå¯é€‰ï¼Œä¸å†éªŒè¯æ–‡ä»¶æ•°é‡
      
      // éªŒè¯ä¸Šä¼ çš„æ–‡ä»¶éƒ½æœ‰æè¿°ï¼ˆåªæœ‰å½“ä¸Šä¼ äº†æ–‡ä»¶æ—¶æ‰éœ€è¦éªŒè¯ï¼‰
      const totalFiles = selectedFiles.image.length + selectedFiles.doc.length + selectedFiles.chat.length;
      if (totalFiles > 0) {
        let missingDescriptions = false;
        ['image', 'doc', 'chat'].forEach(type => {
          for (let i = 0; i < selectedFiles[type].length; i++) {
            if (!fileDescriptions[type][i] || fileDescriptions[type][i].trim() === '') {
              missingDescriptions = true;
            }
          }
        });
        
        if (missingDescriptions) {
          alert('è¯·ä¸ºæ‰€æœ‰è¯æ®æ–‡ä»¶å¡«å†™è¯´æ˜');
          return;
        }
      }
      
      // éªŒè¯è‡³å°‘å¡«å†™äº†ä¸€ä¸ªåå­—
      const cnName = document.getElementById('professor_cn_name').value.trim();
      const enName = document.getElementById('professor_en_name').value.trim();
      if (!cnName && !enName) {
        alert('è¯·è‡³å°‘å¡«å†™TAçš„ä¸­æ–‡åæˆ–è‹±æ–‡åä¹‹ä¸€');
        return;
      }
      
      // æ˜¾ç¤ºAIå®¡æ ¸çŠ¶æ€
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span style="display: inline-flex; align-items: center; gap: 8px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="animation: spin 1s linear infinite;"><circle cx="12" cy="12" r="10"></circle><path d="M12 6v6l4 2"></path></svg>AIé¢„å®¡æ ¸ä¸­...</span>';
      submitBtn.style.opacity = '0.8';
      
      // å…ˆè¿›è¡ŒAIå†…å®¹å®¡æ ¸
      const moderationData = new FormData();
      moderationData.append('csrf_token', form.querySelector('input[name="csrf_token"]').value);
      moderationData.append('description', document.getElementById('description').value);
      moderationData.append('action', 'moderate');
      
      fetch('/upload', {
        method: 'POST',
        body: moderationData
      }).then(response => {
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
      }).then(moderationResult => {
        console.log('ğŸ” [DEBUG] Moderation result:', moderationResult);
        
        if (moderationResult.action === 'FLAG_AND_FIX') {
          // å®¡æ ¸æœªé€šè¿‡ï¼Œæ˜¾ç¤ºä¿®æ”¹å»ºè®®
          console.log('ğŸ” [DEBUG] Moderation failed, showing suggestions');
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
          submitBtn.style.opacity = '1';
          
          // åŠ¨æ€åˆ›å»ºå®¡æ ¸ç»“æœæ˜¾ç¤ºåŒºåŸŸ
          createModerationResultDisplay(moderationResult);
          throw new Error('MODERATION_FAILED'); // æŠ›å‡ºç‰¹å®šé”™è¯¯æ¥åœæ­¢é“¾æ¡æ‰§è¡Œ
        }
        
        console.log('ğŸ” [DEBUG] Moderation passed, proceeding to upload');
        
        // å®¡æ ¸é€šè¿‡ï¼Œé‡ç½®TurnstileçŠ¶æ€ç¡®ä¿æŒ‰é’®æ˜¾ç¤ºæ­£ç¡®
        resetTurnstileAfterModeration();
        
        // å¼€å§‹æ–‡ä»¶ä¸Šä¼ 
        submitBtn.innerHTML = '<span style="display: inline-flex; align-items: center; gap: 8px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="animation: spin 1s linear infinite;"><circle cx="12" cy="12" r="10"></circle><path d="M12 6v6l4 2"></path></svg>ä¸Šä¼ ä¸­...</span>';
        
        const formData = new FormData(form);
        
        // æ¸…é™¤åŸæœ‰çš„æ–‡ä»¶è¾“å…¥
        formData.delete('image_evidences');
        formData.delete('doc_evidences');
        formData.delete('chat_recordings');
        
        // æ·»åŠ æ‰€æœ‰é€‰æ‹©çš„æ–‡ä»¶åŠå…¶æè¿°
        selectedFiles.image.forEach((file, index) => {
          formData.append('image_evidences', file);
          formData.append('image_descriptions', fileDescriptions.image[index]);
        });
        
        selectedFiles.doc.forEach((file, index) => {
          formData.append('doc_evidences', file);
          formData.append('doc_descriptions', fileDescriptions.doc[index]);
        });
        
        selectedFiles.chat.forEach((file, index) => {
          formData.append('chat_recordings', file);
          formData.append('chat_descriptions', fileDescriptions.chat[index]);
        });
        
        // æ·»åŠ å®¡æ ¸é€šè¿‡æ ‡è¯†ï¼Œè·³è¿‡åç«¯é‡å¤å®¡æ ¸
        formData.append('moderation_passed', 'true');
        
        return fetch(form.action, {
          method: 'POST',
          body: formData
        });
      }).then(response => {
        console.log('ğŸ” [DEBUG] Upload response received:', response);
        
        if (!response) {
          throw new Error('No response received from server');
        }
        
        if (response.redirected) {
          // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
          console.log('ğŸ” [DEBUG] Upload successful, redirecting to:', response.url);
          submitBtn.innerHTML = '<span style="display: inline-flex; align-items: center; gap: 8px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 6L9 17l-5-5"></path></svg>æäº¤æˆåŠŸ</span>';
          submitBtn.style.background = '#10B981';
          setTimeout(() => {
            window.location.href = response.url;
          }, 1000);
          return null; // æ˜ç¡®è¿”å›nullï¼Œä¸ç»§ç»­å¤„ç†
        } else {
          console.log('ğŸ” [DEBUG] Upload failed, getting response text');
          return response.text();
        }
      }).then(html => {
        if (html && html.trim()) {
          console.log('ğŸ” [DEBUG] Replacing page content with server response');
          document.open();
          document.write(html);
          document.close();
        }
      }).catch(error => {
        console.log('ğŸ” [DEBUG] Error in form submission:', error);
        
        // å¦‚æœæ˜¯å®¡æ ¸å¤±è´¥ï¼Œä¸æ˜¾ç¤ºç½‘ç»œé”™è¯¯æç¤º
        if (error.message === 'MODERATION_FAILED') {
          console.log('ğŸ” [DEBUG] Moderation failed, not showing network error');
          return;
        }
        
        // çœŸæ­£çš„ç½‘ç»œé”™è¯¯å¤„ç†
        console.error('Network error:', error);
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        submitBtn.style.opacity = '1';
        
        // ä¼˜é›…çš„é”™è¯¯æç¤º
        const errorMessage = document.createElement('div');
        errorMessage.className = 'network-error-tip';
        errorMessage.style.cssText = `
          margin: 16px 0; 
          padding: 12px 16px; 
          background: linear-gradient(135deg, rgba(220, 38, 38, 0.05) 0%, rgba(220, 38, 38, 0.08) 100%);
          border: 1px solid rgba(220, 38, 38, 0.2); 
          border-radius: 10px; 
          color: #B91C1C;
          font-size: 14px;
          text-align: center;
        `;
        errorMessage.innerHTML = 'ğŸŒ ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•';
        
        // æ’å…¥åˆ°è¡¨å•é¡¶éƒ¨
        form.insertBefore(errorMessage, form.firstChild);
        
        // 5ç§’åè‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
          if (errorMessage.parentNode) {
            errorMessage.remove();
          }
        }, 5000);
      });
    });
  });
</script>
<div class="container-narrow">
  {% if config.FLASK_ENV == 'development' %}
  <div style="position: fixed; top: 20px; right: 20px; z-index: 1000;">
    <button type="button" id="dev-autofill-btn" class="btn" style="padding: 10px 20px; font-size: 14px; background: #F59E0B; color: white; border: none; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
      ğŸš€ å¼€å‘å¡«å……
    </button>
  </div>
  {% endif %}
  
  <div class="mb-5">
    <h1 class="section-title">æäº¤æ‚¨çš„è¯„ä»·</h1>
    <p class="section-subtitle">è¯·åŸºäºæ‚¨çš„çœŸå®ç»å†è¿›è¡Œè¯„ä»·ã€‚æäº¤åå°†AIé¢„å®¡åè¿›å…¥äººå·¥å®¡æ ¸æµç¨‹ï¼›æäº¤é€šå¸¸åœ¨çº¦ 30 åˆ†é’Ÿå†…å¤„ç†ã€‚</p>
  </div>

  <form action="/upload" method="post" enctype="multipart/form-data">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    <div class="card mb-4">
      <h3 style="margin-top: 0; margin-bottom: 24px; color: var(--nyu-purple);">è”ç³»ä¿¡æ¯</h3>
      <div class="form-group">
        <label for="submitter_email">æ‚¨çš„é‚®ç®± <span style="color: #DC2626;">*</span></label>
        <input id="submitter_email" type="email" name="submitter_email" value="{{ form_data.submitter_email if form_data else '' }}" required placeholder="you@example.com" />
        <div class="text-light mt-1" style="font-size: 14px;">ä»…ç”¨äºä¸æ‚¨è”ç³»ä¸é€šçŸ¥è¿›åº¦</div>
      </div>
    </div>

    <div class="card mb-4">
      <h3 style="margin-top: 0; margin-bottom: 24px; color: var(--nyu-purple);">TAçš„ä¿¡æ¯</h3>

      <div class="grid grid-2 mb-0">
        <div class="form-group">
          <label for="professor_cn_name">TAçš„ä¸­æ–‡å</label>
          <input id="professor_cn_name" type="text" name="professor_cn_name" value="{{ form_data.professor_cn_name if form_data else '' }}" placeholder="ä¾‹å¦‚ï¼šæå››" />
          <div class="text-light mt-1" style="font-size: 14px;">
            æˆ‘ä»¬ä»…åœ¨ç²¾å‡†å§“ååŒ¹é…æœç´¢æ—¶æ˜¾ç¤ºå…¨å
          </div>
        </div>
        <div class="form-group">
          <label for="professor_en_name">TAçš„è‹±æ–‡å…¨å</label>
          <input id="professor_en_name" type="text" name="professor_en_name" value="{{ form_data.professor_en_name if form_data else '' }}" placeholder="ä¾‹å¦‚ï¼šAlice Li" />
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <h3 style="margin-top: 0; margin-bottom: 24px; color: var(--nyu-purple);">è¯„ä»·å†…å®¹</h3>
      
      <div class="form-group">
        <label>æ ‡ç­¾é€‰æ‹©</label>
        
        <div style="margin-top: 16px; margin-bottom: 24px;">
          <div class="tag-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 16px;">
            <label class="tag-minimal-blue" style="display: flex; align-items: center; padding: 12px 16px; border: 1px solid #E2E8F0; background: #FAFAFA; border-radius: 12px; cursor: pointer; transition: all 0.2s ease;">
              <input type="checkbox" name="tag_loyal" style="margin-right: 10px; width: auto;" {{ 'checked' if form_data and form_data.tag_loyal else '' }} /> 
              <span style="color: #475569; font-weight: 400; font-size: 14px;">å¿ è¯š</span>
            </label>
            <label class="tag-minimal-blue" style="display: flex; align-items: center; padding: 12px 16px; border: 1px solid #E2E8F0; background: #FAFAFA; border-radius: 12px; cursor: pointer; transition: all 0.2s ease;">
              <input type="checkbox" name="tag_stable" style="margin-right: 10px; width: auto;" {{ 'checked' if form_data and form_data.tag_stable else '' }} /> 
              <span style="color: #475569; font-weight: 400; font-size: 14px;">æƒ…ç»ªç¨³å®š</span>
            </label>
            <label class="tag-minimal-blue" style="display: flex; align-items: center; padding: 12px 16px; border: 1px solid #E2E8F0; background: #FAFAFA; border-radius: 12px; cursor: pointer; transition: all 0.2s ease;">
              <input type="checkbox" name="tag_sincere" style="margin-right: 10px; width: auto;" {{ 'checked' if form_data and form_data.tag_sincere else '' }} /> 
              <span style="color: #475569; font-weight: 400; font-size: 14px;">çœŸè¯šä»˜å‡º</span>
            </label>
            <label class="tag-minimal-blue" style="display: flex; align-items: center; padding: 12px 16px; border: 1px solid #E2E8F0; background: #FAFAFA; border-radius: 12px; cursor: pointer; transition: all 0.2s ease;">
              <input type="checkbox" name="tag_humorous" style="margin-right: 10px; width: auto;" {{ 'checked' if form_data and form_data.tag_humorous else '' }} /> 
              <span style="color: #475569; font-weight: 400; font-size: 14px;">å¹½é»˜</span>
            </label>
          </div>
          <div class="tag-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
            <label class="tag-minimal-red" style="display: flex; align-items: center; padding: 12px 16px; border: 1px solid #E2E8F0; background: #FAFAFA; border-radius: 12px; cursor: pointer; transition: all 0.2s ease;">
              <input type="checkbox" name="tag_positive" style="margin-right: 10px; width: auto;" {{ 'checked' if form_data and form_data.tag_positive else '' }} /> 
              <span style="color: #475569; font-weight: 400; font-size: 14px;">å‡ºè½¨</span>
            </label>
            <label class="tag-minimal-red" style="display: flex; align-items: center; padding: 12px 16px; border: 1px solid #E2E8F0; background: #FAFAFA; border-radius: 12px; cursor: pointer; transition: all 0.2s ease;">
              <input type="checkbox" name="tag_calm" style="margin-right: 10px; width: auto;" {{ 'checked' if form_data and form_data.tag_calm else '' }} /> 
              <span style="color: #475569; font-weight: 400; font-size: 14px;">å†·æš´åŠ›</span>
            </label>
            <label class="tag-minimal-red" style="display: flex; align-items: center; padding: 12px 16px; border: 1px solid #E2E8F0; background: #FAFAFA; border-radius: 12px; cursor: pointer; transition: all 0.2s ease;">
              <input type="checkbox" name="tag_leadership" style="margin-right: 10px; width: auto;" {{ 'checked' if form_data and form_data.tag_leadership else '' }} /> 
              <span style="color: #475569; font-weight: 400; font-size: 14px;">PUA</span>
            </label>
            <label class="tag-minimal-red" style="display: flex; align-items: center; padding: 12px 16px; border: 1px solid #E2E8F0; background: #FAFAFA; border-radius: 12px; cursor: pointer; transition: all 0.2s ease;">
              <input type="checkbox" name="tag_homework_heavy" style="margin-right: 10px; width: auto;" {{ 'checked' if form_data and form_data.tag_homework_heavy else '' }} /> 
              <span style="color: #475569; font-weight: 400; font-size: 14px;">éª—é’±</span>
            </label>
          </div>
        </div>
      </div>

      <!-- æš‚æ—¶æ³¨é‡Šæ‰è‡ªå®šä¹‰æ ‡ç­¾ä»¥èŠ‚çœé¡µé¢ç©ºé—´
      <div class="form-group mt-3">
        <label for="tag_custom">è‡ªå®šä¹‰æ ‡ç­¾</label>
        <input id="tag_custom" type="text" name="tag_custom" value="{{ form_data.tag_custom if form_data else '' }}" placeholder="ä¾‹å¦‚ï¼šä¹–ä¹–å°å¥¶ç‹—" />
      </div>
      -->

      <div class="form-group">
        <label for="description">è¯¦ç»†æè¿° <span style="color: #DC2626;">*</span></label>
        <textarea id="description" name="description" rows="8" required 
                  placeholder="è¯·æè¿°æ‚¨ä¸ªäººçš„çœŸå®ç»å†ï¼Œé¿å…æ— ç«¯æŒ‡æ§å’Œä»»ä½•éšç§ä¿¡æ¯ã€‚æ¨èåŒ…å«æ–°é—»å…­è¦ç´ ï¼šæ—¶é—´ã€åœ°ç‚¹ã€äººç‰©ï¼ˆä½¿ç”¨ä»£ç§°ï¼‰ã€èµ·å› ã€ç»è¿‡ã€ç»“æœã€‚"
                  style="min-height: 150px;">{{ form_data.description if form_data else '' }}</textarea>
      </div>
    </div>

    <!-- å†…å®¹å®¡æ ¸ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
    {% if form_data and form_data.moderation_result %}
    <div class="card mb-4" style="border-left: 4px solid #F59E0B; background-color: #FFFBEB;">
      <h3 style="margin-top: 0; margin-bottom: 16px; color: #D97706;">
        <i class="icon-warning" style="margin-right: 8px;">âš ï¸</i>
        å†…å®¹éœ€è¦ä¿®æ”¹
      </h3>
      
      <div class="alert alert-warning mb-3">
        <div class="alert-content">
          <strong>å®¡æ ¸æç¤ºï¼š</strong>{{ form_data.moderation_result.client_notice }}
        </div>
      </div>

      {% if form_data.moderation_result.required_changes %}
      <div class="mb-3">
        <h4 style="margin-bottom: 12px; color: #92400E;">éœ€è¦ä¿®æ”¹çš„é—®é¢˜ï¼š</h4>
        <ul style="margin: 0; padding-left: 20px;">
          {% for change in form_data.moderation_result.required_changes %}
          <li style="margin-bottom: 8px; color: #92400E;">{{ change.fix }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      {% if form_data.moderation_result.safe_suggestion %}
      <div class="mb-3">
        <h4 style="margin-bottom: 12px; color: #059669;">å»ºè®®æ”¹å†™ç‰ˆæœ¬ï¼š</h4>
        <div style="background: #F0FDF4; border: 1px solid #BBF7D0; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
          <p style="margin: 0; line-height: 1.5; color: #065F46;">{{ form_data.moderation_result.safe_suggestion }}</p>
        </div>
        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
          <button type="button" id="accept-suggestion" class="btn" style="background: #059669; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
            é‡‡ç”¨å»ºè®®ç‰ˆæœ¬
          </button>
          <button type="button" id="edit-manual" class="btn" style="background: #6B7280; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
            æ‰‹åŠ¨ä¿®æ”¹
          </button>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- æ—§çš„æœåŠ¡å™¨ç«¯å®¡æ ¸ç»“æœå¤„ç†ä»£ç å·²ç§»é™¤ï¼Œç°åœ¨ä½¿ç”¨JavaScriptåŠ¨æ€ç”Ÿæˆ -->
    {% endif %}

    <div class="card mb-4">
      <h3 style="margin-top: 0; margin-bottom: 24px; color: var(--nyu-purple);">è¯æ®ææ–™ï¼ˆæ¨èï¼‰</h3>
      
      <div class="alert alert-info mb-3">
        <div class="alert-content">
          <strong>éšç§ä¿æŠ¤æç¤º</strong>
          <p style="margin: 8px 0 0;">ç³»ç»Ÿå°†å¯¹è¯æ®æ–‡ä»¶è¿›è¡Œå……åˆ†æ¨¡ç³ŠåŒ–å¤„ç†ï¼›åŸå§‹æ–‡ä»¶ä»…ä¾›å®¡æ ¸ä½¿ç”¨ï¼Œå¯¹å¤–ä¸å¯è®¿é—®ã€‚<strong style="color: #DC2626;"></strong></p>
        </div>
    </div>

      <div class="form-group">
        <label>è¯æ®æ–‡ä»¶</label>
        <div class="file-upload-container">
          <input type="file" id="all_evidences" name="all_evidences" 
                 accept="image/*,.pdf,.txt,.doc,.docx,video/*" multiple 
                 style="display: none;" />
          <div class="file-drop-zone" onclick="document.getElementById('all_evidences').click()">
            <svg width="40" height="40" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="opacity: 0.4; margin-bottom: 8px;">
              <path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            <p style="margin: 0; color: var(--text-primary); font-weight: 500;">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</p>
            <p style="margin: 8px 0 0; color: var(--text-light); font-size: 14px;">
              æ”¯æŒæ–‡æ¡£ã€å›¾ç‰‡ã€è§†é¢‘ï¼ˆå¦‚ï¼šPDFã€JPGã€PNGã€MP4ï¼‰
            </p>
          </div>
          <div class="files-list" id="unified-files-list"></div>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <h3 style="margin-top: 0; margin-bottom: 24px; color: var(--nyu-purple);">éšç§è®¾ç½®</h3>

      <div style="display: flex; flex-direction: column; gap: 16px;">
        <label class="privacy-checkbox" style="display: flex; align-items: flex-start; padding: 16px; background: var(--surface-secondary); border-radius: 10px; cursor: pointer;">
          <input type="checkbox" name="privacy_homepage" style="margin-right: 12px; margin-top: 2px; width: 18px; height: 18px; min-width: 18px; flex-shrink: 0;" checked />
          <div>
            <div style="font-weight: 600; margin-bottom: 4px;">å±•ç¤ºåˆ°é¦–é¡µ</div>
            <div class="text-light" style="font-size: 14px;">æ‚¨çš„è¯„ä»·å°†å¯èƒ½å‡ºç°åœ¨é¦–é¡µç²¾é€‰å±•ç¤ºä¸­ï¼ˆå§“åä¼šè¢«ä¿æŠ¤ï¼‰</div>
          </div>
        </label>

        <label class="privacy-checkbox required" style="display: flex; align-items: flex-start; padding: 16px; background: var(--surface-secondary); border-radius: 10px; cursor: pointer; border: 1px solid var(--border-light);">
          <input type="checkbox" name="legal_agreement" required style="margin-right: 12px; margin-top: 2px; width: 18px; height: 18px; min-width: 18px; flex-shrink: 0;" />
          <div>
            <div style="font-weight: 600; margin-bottom: 4px;">æ³•å¾‹æ¡æ¬¾åŒæ„ <span style="color: #DC2626;">*</span></div>
            <div class="text-light" style="font-size: 14px;">
              æˆ‘å·²é˜…è¯»å¹¶åŒæ„ 
              <a href="#" onclick="openLegalModal('terms'); return false;" style="color: var(--nyu-purple); text-decoration: none; border-bottom: 1px solid var(--nyu-purple);">æœåŠ¡æ¡æ¬¾</a> å’Œ 
              <a href="#" onclick="openLegalModal('privacy'); return false;" style="color: var(--nyu-purple); text-decoration: none; border-bottom: 1px solid var(--nyu-purple);">éšç§æ”¿ç­–</a>ã€‚
            </div>
          </div>
        </label>
      </div>
    </div>

    {% if config.TURNSTILE_SITE_KEY %}
    <div class="mt-3" style="display:flex; flex-direction:column; align-items:center; gap:16px;">
      <div id="ts-container" style="display: none;"></div>
      <div id="ts-status" class="text-light" style="font-size:13px; text-align:center;">
        <span style="color: var(--text-secondary);">äººæœºéªŒè¯å°†åœ¨å‹¾é€‰æ³•å¾‹æ¡æ¬¾åŒæ„åè‡ªåŠ¨åŠ è½½</span>
      </div>
    </div>
    <script>
      // Turnstile äººæœºéªŒè¯ç®¡ç†
      class TurnstileManager {
        constructor() {
          this.isReady = false;
          this.lastTokenTime = 0;
          this.token = '';
          this.maxRetries = 3;
          this.retryCount = 0;
          this.widgetId = null;
          
          // åˆ›å»ºå…¨å±€å›è°ƒå‡½æ•°ï¼ˆé¿å… bind å¯¼è‡´çš„é—®é¢˜ï¼‰
          const self = this;
          window.onTsOk = function(token) {
            console.log('ğŸ” [DEBUG] Global onTsOk called with token:', token);
            self.onSuccess(token);
          };
          window.onTsExpired = function() {
            console.log('ğŸ” [DEBUG] Global onTsExpired called');
            self.onExpired();
          };
          window.onTsError = function(errorCode) {
            console.log('ğŸ” [DEBUG] Global onTsError called with code:', errorCode);
            self.onError(errorCode);
          };
        }
        
        setStatus(text, isSuccess = false) {
          const statusEl = document.getElementById('ts-status');
          if (!statusEl) return;
          
          // ä½¿ç”¨ innerHTML ä»¥æ”¯æŒ HTML å†…å®¹
          statusEl.innerHTML = text;
          statusEl.style.color = isSuccess ? '#059669' : '#64748B';
          
          if (isSuccess) {
            statusEl.style.fontWeight = '500';
          } else {
            statusEl.style.fontWeight = 'normal';
          }
        }
        
        setSubmitEnabled(enabled) {
          console.log('ğŸ” [DEBUG] setSubmitEnabled called with:', enabled);
          
          // ä½¿ç”¨ç°æœ‰çš„toggleSubmitå‡½æ•°æ¥ä¿æŒä¸€è‡´æ€§
          if (typeof toggleSubmit === 'function') {
            if (!enabled) {
              // æ ¹æ®å½“å‰çŠ¶æ€æ˜¾ç¤ºä¸åŒçš„æ–‡æœ¬
              const legalCheckbox = document.querySelector('input[name="legal_agreement"]');
              let waitText = 'ç­‰å¾…éªŒè¯...';
              if (!legalCheckbox || !legalCheckbox.checked) {
                waitText = 'è¯·å…ˆåŒæ„æ³•å¾‹æ¡æ¬¾';
              } else if (!this.widgetId) {
                waitText = 'æ­£åœ¨åŠ è½½éªŒè¯...';
              } else {
                waitText = 'ç­‰å¾…éªŒè¯...';
              }
              toggleSubmit(true, waitText);
            } else {
              toggleSubmit(false);
            }
          } else {
            // å¦‚æœtoggleSubmitä¸å­˜åœ¨ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
            const submitBtn = document.querySelector('button[type="submit"].btn-primary');
            if (submitBtn) {
              submitBtn.disabled = !enabled;
              if (enabled) {
                submitBtn.textContent = 'æäº¤è¯„ä»·';
                submitBtn.style.opacity = '1';
                submitBtn.style.cursor = 'pointer';
              } else {
                const legalCheckbox = document.querySelector('input[name="legal_agreement"]');
                let waitText = 'ç­‰å¾…éªŒè¯...';
                if (!legalCheckbox || !legalCheckbox.checked) {
                  waitText = 'è¯·å…ˆåŒæ„æ³•å¾‹æ¡æ¬¾';
                } else if (!this.widgetId) {
                  waitText = 'æ­£åœ¨åŠ è½½éªŒè¯...';
                } else {
                  waitText = 'ç­‰å¾…éªŒè¯...';
                }
                submitBtn.textContent = waitText;
                submitBtn.style.opacity = '0.6';
                submitBtn.style.cursor = 'not-allowed';
              }
            }
          }
        }
        
        ensureHiddenInput() {
          const form = document.querySelector('form[action="/upload"]');
          if (!form) return null;
          
          let hiddenInput = form.querySelector('input[name="cf-turnstile-response"]');
          if (!hiddenInput) {
            hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'cf-turnstile-response';
            form.appendChild(hiddenInput);
          }
          return hiddenInput;
        }
        
        onSuccess(token) {
          console.log('ğŸ” [DEBUG] Turnstile onSuccess called');
          console.log('ğŸ” [DEBUG] Token received:', token);
          console.log('ğŸ” [DEBUG] Token type:', typeof token);
          console.log('ğŸ” [DEBUG] Token length:', token ? token.length : 0);
          
          this.token = token || '';
          this.isReady = !!token;
          this.lastTokenTime = Date.now();
          this.retryCount = 0;
          
          console.log('ğŸ” [DEBUG] this.isReady:', this.isReady);
          
          const hiddenInput = this.ensureHiddenInput();
          if (hiddenInput) {
            hiddenInput.value = this.token;
            console.log('ğŸ” [DEBUG] Hidden input updated with token');
          }
          
          if (this.isReady) {
            console.log('ğŸ” [DEBUG] Setting success status and enabling submit');
            this.setStatus('âœ“ äººæœºéªŒè¯å·²é€šè¿‡', true);
            this.setSubmitEnabled(true);
            
            // å¼ºåˆ¶æ›´æ–°æŒ‰é’®çŠ¶æ€
            setTimeout(() => {
              console.log('ğŸ” [DEBUG] Force updating submit button state');
              this.setSubmitEnabled(true);
            }, 100);
          } else {
            console.log('ğŸ” [DEBUG] Token invalid, setting failure status');
            this.setStatus('âŒ éªŒè¯å¤±è´¥ï¼Œè¯·é‡è¯•', false);
            this.setSubmitEnabled(false);
          }
        }
        
        onExpired() {
          console.log('Turnstile expired');
          
          this.isReady = false;
          this.lastTokenTime = 0;
          this.token = '';
          
          this.setStatus('éªŒè¯å·²è¿‡æœŸï¼Œæ­£åœ¨é‡æ–°åŠ è½½...', false);
          this.setSubmitEnabled(false);
          
          setTimeout(() => this.reset(), 1000);
        }
        
        onError(errorCode) {
          console.warn('Turnstile encountered an issue:', errorCode || 'Unknown error');
          
          this.isReady = false;
          this.retryCount++;
          
          // ç‰¹åˆ«å¤„ç† 401 é”™è¯¯
          if (errorCode === '401' || errorCode === 401) {
            this.setStatus('âŒ äººæœºéªŒè¯é…ç½®é”™è¯¯ (401)ï¼Œè¯·è”ç³»ç®¡ç†å‘˜', false);
            const statusEl = document.getElementById('ts-status');
            if (statusEl) {
              statusEl.innerHTML = `
                <div style="color: #DC2626; font-weight: 500;">âŒ äººæœºéªŒè¯é…ç½®é”™è¯¯</div>
                <div style="font-size: 11px; color: var(--text-light); margin-top: 4px;">
                  é”™è¯¯ä»£ç : 401 - è¯·è”ç³»ç½‘ç«™ç®¡ç†å‘˜æ£€æŸ¥åŸŸåé…ç½®
                </div>
                <button onclick="this.parentElement.style.display='none'" style="margin-top: 8px; padding: 4px 8px; border: 1px solid #DC2626; background: transparent; color: #DC2626; border-radius: 4px; cursor: pointer; font-size: 11px;">æš‚æ—¶è·³è¿‡éªŒè¯</button>
              `;
            }
            // åœ¨é…ç½®é”™è¯¯æ—¶å…è®¸æäº¤ï¼ˆé™çº§å¤„ç†ï¼‰
            setTimeout(() => {
              this.setSubmitEnabled(true);
              this.isReady = true;
            }, 3000);
            return;
          }
          
          if (this.retryCount < this.maxRetries) {
            this.setStatus(`éªŒè¯é‡åˆ°é—®é¢˜ï¼Œæ­£åœ¨é‡è¯• (${this.retryCount}/${this.maxRetries})...`, false);
            setTimeout(() => this.reset(), 2000);
          } else {
            this.setStatus('äººæœºéªŒè¯æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', false);
            // åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œå³ä½¿éªŒè¯å¤±è´¥ä¹Ÿå¯ä»¥è€ƒè™‘å…è®¸æäº¤
            if (window.location.hostname !== 'localhost' && this.retryCount >= this.maxRetries) {
              console.warn('Turnstile max retries reached, but allowing form submission in production');
              this.setSubmitEnabled(true);
              this.isReady = true; // å…è®¸è¡¨å•æäº¤
            }
          }
          
          if (!this.isReady) {
            this.setSubmitEnabled(false);
          }
        }
        
        reset() {
          try {
            if (window.turnstile && typeof window.turnstile.reset === 'function') {
              if (this.widgetId !== null) {
                window.turnstile.reset(this.widgetId);
              } else {
                window.turnstile.reset();
              }
              console.log('Turnstile reset successful');
            }
          } catch (error) {
            console.error('Failed to reset turnstile:', error);
            this.setStatus('é‡ç½®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢', false);
          }
        }
        
        isTokenValid() {
          if (!this.token || !this.isReady) return false;
          
          // æ£€æŸ¥tokenæ˜¯å¦è¿‡æœŸï¼ˆ90ç§’å†…æœ‰æ•ˆï¼‰
          const tokenAge = Date.now() - this.lastTokenTime;
          return tokenAge < 90000; // 90ç§’
        }
        
        setupFormValidation() {
          const form = document.querySelector('form[action="/upload"]');
          if (!form) return;
          
          // åˆå§‹çŠ¶æ€ç¦ç”¨æäº¤æŒ‰é’®
          this.setSubmitEnabled(false);
          
          // æ³¨å†Œ Turnstile éªŒè¯æ£€æŸ¥å™¨ï¼ˆä¸æ‹¦æˆªæäº¤ï¼Œåªè¿›è¡ŒéªŒè¯ï¼‰
          window.turnstileValidation = () => {
            console.log('ğŸ” [DEBUG] Checking Turnstile validation');
            
            // æ£€æŸ¥æ³•å¾‹æ¡æ¬¾
            const legalCheckbox = document.querySelector('input[name="legal_agreement"]');
            if (!legalCheckbox || !legalCheckbox.checked) {
              console.log('ğŸ” [DEBUG] Legal agreement not checked');
              return { valid: false, reason: 'legal_agreement' };
            }
            
            // æ£€æŸ¥ Turnstile éªŒè¯
            if (!this.isTokenValid()) {
              console.log('ğŸ” [DEBUG] Turnstile token invalid', { token: this.token, isReady: this.isReady });
              if (this.token && !this.isTokenValid()) {
                this.setStatus('éªŒè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°éªŒè¯', false);
                this.reset();
                return { valid: false, reason: 'expired' };
              } else {
                this.setStatus('è¯·å…ˆå®ŒæˆäººæœºéªŒè¯', false);
                return { valid: false, reason: 'not_completed' };
              }
            }
            
            console.log('ğŸ” [DEBUG] Turnstile validation passed');
            return { valid: true };
          };
          
          // å®šæœŸæ£€æŸ¥tokenæ˜¯å¦å³å°†è¿‡æœŸ
          setInterval(() => {
            if (this.isReady && this.lastTokenTime) {
              const tokenAge = Date.now() - this.lastTokenTime;
              if (tokenAge > 75000 && tokenAge < 90000) { // 75-90ç§’ä¹‹é—´é¢„è­¦
                this.setStatus('éªŒè¯å³å°†è¿‡æœŸï¼Œæ­£åœ¨è‡ªåŠ¨åˆ·æ–°...', false);
                this.setSubmitEnabled(false);
                setTimeout(() => this.reset(), 1000);
              }
            }
          }, 10000); // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
        }
        
        initializeTurnstile() {
          // åªæœ‰åœ¨æ³•å¾‹æ¡æ¬¾åŒæ„åæ‰åˆå§‹åŒ–Turnstile
          const container = document.getElementById('ts-container');
          const statusEl = document.getElementById('ts-status');
          
          if (!container || !statusEl) {
            console.error('Turnstile container or status element not found');
            return;
          }
          
          // æ˜¾ç¤ºå®¹å™¨å’ŒçŠ¶æ€
          container.style.display = 'block';
          statusEl.style.display = 'block';
          
          // åˆ›å»ºTurnstile widget
          container.className = 'cf-turnstile';
          container.setAttribute('data-sitekey', '{{ config.TURNSTILE_SITE_KEY }}');
          container.setAttribute('data-theme', 'auto');
          container.setAttribute('data-size', 'normal');
          // ä¸è®¾ç½® data-* å›è°ƒï¼Œåªåœ¨ render æ—¶è®¾ç½®
          
          this.setStatus('æ­£åœ¨åŠ è½½äººæœºéªŒè¯...', false);
          
          // ç­‰å¾…Turnstile APIåŠ è½½å®Œæˆç„¶åæ¸²æŸ“
          const checkAndRender = () => {
            if (window.turnstile && typeof window.turnstile.render === 'function') {
              try {
                this.widgetId = window.turnstile.render('#ts-container', {
                  sitekey: '{{ config.TURNSTILE_SITE_KEY }}',
                  theme: 'auto',
                  size: 'normal',
                  callback: window.onTsOk,
                  'expired-callback': window.onTsExpired,
                  'error-callback': window.onTsError
                });
                console.log('Turnstile widget rendered successfully', this.widgetId);
                this.setStatus('è¯·å®ŒæˆäººæœºéªŒè¯', false);
              } catch (error) {
                console.error('Failed to render Turnstile:', error);
                this.setStatus('âš ï¸ äººæœºéªŒè¯åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', false);
                // åœ¨éªŒè¯å¤±è´¥æ—¶ï¼Œç»™ç”¨æˆ·ä¸€ä¸ªæ‰‹åŠ¨é‡è¯•çš„é€‰é¡¹
                setTimeout(() => {
                  const statusEl = document.getElementById('ts-status');
                  if (statusEl) {
                    statusEl.innerHTML = 'âš ï¸ äººæœºéªŒè¯åŠ è½½å¤±è´¥ <button onclick="location.reload()" style="margin-left: 8px; padding: 4px 8px; border: 1px solid var(--nyu-purple); background: transparent; color: var(--nyu-purple); border-radius: 4px; cursor: pointer; font-size: 12px;">åˆ·æ–°é‡è¯•</button>';
                  }
                }, 1000);
              }
            } else {
              setTimeout(checkAndRender, 500);
            }
          };
          checkAndRender();
        }
        
        initialize() {
          // è®¾ç½®è¡¨å•éªŒè¯ä½†ä¸åˆå§‹åŒ–Turnstile
          this.setupFormValidation();
          
          // ç›‘å¬æ³•å¾‹æ¡æ¬¾å¤é€‰æ¡†
          const legalCheckbox = document.querySelector('input[name="legal_agreement"]');
          if (legalCheckbox) {
            legalCheckbox.addEventListener('change', (e) => {
              if (e.target.checked && !this.widgetId) {
                // ç¬¬ä¸€æ¬¡å‹¾é€‰æ—¶åˆå§‹åŒ–Turnstile
                this.setStatus('âœ… æ³•å¾‹æ¡æ¬¾å·²ç¡®è®¤ï¼Œæ­£åœ¨åŠ è½½äººæœºéªŒè¯...', false);
                this.initializeTurnstile();
              } else if (!e.target.checked) {
                // å–æ¶ˆå‹¾é€‰æ—¶éšè—Turnstile
                const container = document.getElementById('ts-container');
                const statusEl = document.getElementById('ts-status');
                if (container) container.style.display = 'none';
                if (statusEl) {
                  statusEl.innerHTML = '<span style="color: var(--text-secondary);">äººæœºéªŒè¯å°†åœ¨å‹¾é€‰æ³•å¾‹æ¡æ¬¾åŒæ„åè‡ªåŠ¨åŠ è½½</span>';
                }
                this.isReady = false;
                this.token = '';
                this.setSubmitEnabled(false);
              }
            });
          }
          
          // åˆå§‹çŠ¶æ€ï¼šç¦ç”¨æäº¤ï¼Œç›´åˆ°éªŒè¯å®Œæˆ
          this.setSubmitEnabled(false);
        }
      }
      
      // åˆå§‹åŒ–Turnstileç®¡ç†å™¨
      const turnstileManager = new TurnstileManager();
      turnstileManager.initialize();
      
      // å‡å°‘Turnstileè°ƒè¯•ä¿¡æ¯ï¼ˆä»…åœ¨ç”Ÿäº§ç¯å¢ƒï¼‰
      if (window.location.hostname !== 'localhost') {
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        console.error = function(...args) {
          const message = args[0];
          if (typeof message === 'string' && (
            message.includes('challenges.cloudflare.com') ||
            message.includes('Turnstile') ||
            message.includes('frame with origin')
          )) {
            return; // é™é»˜å¤„ç† Turnstile ç›¸å…³é”™è¯¯
          }
          originalConsoleError.apply(console, args);
        };
        
        console.warn = function(...args) {
          const message = args[0];
          if (typeof message === 'string' && message.includes('styleMedia is a deprecated')) {
            return; // é™é»˜å¤„ç†æ ·å¼åª’ä½“æŸ¥è¯¢è­¦å‘Š
          }
          originalConsoleWarn.apply(console, args);
        };
      }

      // å¼€å‘æ¨¡å¼è‡ªåŠ¨å¡«å……åŠŸèƒ½
      {% if config.FLASK_ENV == 'development' %}
      if (document.getElementById('dev-autofill-btn')) {
        document.getElementById('dev-autofill-btn').addEventListener('click', function() {
          console.log('ğŸš€ å¼€å§‹è‡ªåŠ¨å¡«å……...');
          
          // å¡«å……è”ç³»ä¿¡æ¯
          document.getElementById('submitter_email').value = 'developer@nyudate.com';
          
          // å¡«å……TAä¿¡æ¯
          document.getElementById('professor_cn_name').value = 'å¼ å°æ˜';
          document.getElementById('professor_en_name').value = 'Zhang Xiaoming';
          document.getElementById('professor_unique_identifier').value = 'zx123';
          document.getElementById('professor_birthday').value = '1990-05-15';
          
          // é€‰æ‹©ä¸€äº›æ ‡ç­¾
          document.getElementById('tag_positive').checked = true;
          document.getElementById('tag_loyal').checked = true;
          document.getElementById('tag_humorous').checked = true;
          
          // å¡«å……è‡ªå®šä¹‰æ ‡ç­¾ (å·²æ³¨é‡Š)
          // document.getElementById('tag_custom').value = 'è¯¾å ‚æ´»è·ƒ';
          
          // å¡«å……è¯¦ç»†æè¿°
          document.getElementById('description').value = 'è¿™ä½TAåœ¨è¯¾å ‚ä¸Šè¡¨ç°éå¸¸ä¸“ä¸šï¼Œæ€»æ˜¯å‡†æ—¶åˆ°è¾¾ï¼Œè®²è§£æ¸…æ™°æ˜“æ‡‚ã€‚åœ¨åŠå…¬æ—¶é—´ä¹Ÿå¾ˆè€å¿ƒå›ç­”å­¦ç”Ÿé—®é¢˜ï¼Œä½œä¸šæ‰¹æ”¹åŠæ—¶ä¸”æœ‰è¯¦ç»†åé¦ˆã€‚ç‰¹åˆ«æ˜¯åœ¨æœŸä¸­è€ƒè¯•å‰çš„å¤ä¹ è¯¾ï¼Œå‡†å¤‡äº†å¾ˆå¤šé¢å¤–çš„ç»ƒä¹ é¢˜å¸®åŠ©æˆ‘ä»¬ç†è§£éš¾ç‚¹ã€‚æ•´ä½“æ¥è¯´æ˜¯ä¸€ä½è´Ÿè´£ä»»ä¸”æœ‰è¶£çš„TAã€‚';
          
          // æ˜¾ç¤ºæˆåŠŸæç¤º
          this.style.background = '#059669';
          this.textContent = 'âœ… å·²å¡«å……';
          setTimeout(() => {
            this.style.background = '#F59E0B';
            this.textContent = 'ğŸš€ å¼€å‘å¡«å……';
          }, 2000);
          
          console.log('âœ… è‡ªåŠ¨å¡«å……å®Œæˆ');
        });
      }
      {% endif %}

      // Global function for opening legal modal
      window.openLegalModal = function(docType) {
        const url = docType === 'terms' ? '/terms' : '/privacy';
        
        // Check if we're on mobile or prefer new tab
        if (window.innerWidth <= 768) {
          window.open(url, '_blank');
        } else {
          // Create iframe modal for desktop
          createIframeModal(url);
        }
      };

      // Create iframe modal for desktopï¼ˆä¸ base.html ç‰ˆæœ¬ä¿æŒä¸€è‡´é£æ ¼ + å¤ç”¨ç¼“å­˜ï¼‰
      function createIframeModal(url) {
        const existing = document.getElementById('legal-iframe-modal');
        if (existing) existing.remove();

        const overlay = document.createElement('div');
        overlay.id = 'legal-iframe-modal';
        overlay.setAttribute('style', 'position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: transparent; z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; animation: fadeIn 0.15s ease; overscroll-behavior: contain;');

        // Scroll lock
        const htmlEl = document.documentElement;
        const bodyEl = document.body;
        const prevHtmlOverflow = htmlEl.style.overflow;
        const prevBodyOverflow = bodyEl.style.overflow;
        htmlEl.style.overflow = 'hidden';
        bodyEl.style.overflow = 'hidden';

        const closeOverlay = () => {
          overlay.remove();
          htmlEl.style.overflow = prevHtmlOverflow;
          bodyEl.style.overflow = prevBodyOverflow;
          window.removeEventListener('keydown', escHandler);
          window.removeEventListener('message', messageHandler);
        };
        overlay.addEventListener('click', closeOverlay);

        window._legalIframeCache = window._legalIframeCache || {};
        let iframe = window._legalIframeCache[url];
        if (!iframe) {
          iframe = document.createElement('iframe');
          iframe.src = url;
          window._legalIframeCache[url] = iframe;
        }
        iframe.setAttribute('allowtransparency', 'true');
        iframe.style.cssText = 'width: 100%; max-width: 900px; height: 88vh; border: none; border-radius: 16px; background: white; box-shadow: 0 8px 24px rgba(10, 14, 39, 0.08), 0 2px 8px rgba(10, 14, 39, 0.06); outline: 1px solid rgba(0,0,0,0.06); overscroll-behavior: contain;';
        iframe.addEventListener('click', function(e){ e.stopPropagation(); });

        overlay.appendChild(iframe);
        document.body.appendChild(overlay);

        const messageHandler = (event) => {
          if (event.data === 'closeLegalModal') {
            closeOverlay();
          }
        };
        window.addEventListener('message', messageHandler);

        const escHandler = (event) => {
          if (event.key === 'Escape') {
            closeOverlay();
          }
        };
        window.addEventListener('keydown', escHandler);
      }
    </script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    {% endif %}
    
    <div class="submit-buttons" style="display: flex; gap: 16px; justify-content: center;">
      <button class="btn btn-primary" type="submit" style="padding: 14px 32px; font-size: 16px;">
        æäº¤è¯„ä»·
      </button>
      <a class="btn" href="/" style="padding: 14px 32px; font-size: 16px;">è¿”å›é¦–é¡µ</a>
    </div>
  </form>
</div>
{% endblock %}
