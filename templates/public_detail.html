{% extends 'base.html' %}
{% block content %}
<style>
  /* ==================== Detail Page - Apple Style ==================== */
  .detail-hero {
    text-align: center;
    padding: 48px 24px 32px;
    max-width: 800px;
    margin: 0 auto;
  }

  .detail-hero h1 {
    font-size: 40px;
    font-weight: 700;
    line-height: 1.1;
    letter-spacing: -0.008em;
    margin-bottom: 12px;
    background: linear-gradient(135deg, var(--nyu-purple) 0%, var(--nyu-purple-light) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .detail-hero p {
    font-size: 17px;
    line-height: 1.47;
    color: var(--text-secondary);
    letter-spacing: -0.016em;
  }

  .detail-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 24px 48px;
  }

  .detail-card {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.08);
    border-radius: 16px;
    padding: 32px;
    margin-bottom: 20px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    position: relative;
  }

  .like-button {
    position: absolute;
    top: 24px;
    right: 24px;
    background: rgba(0, 0, 0, 0.04);
    border: 1px solid rgba(0, 0, 0, 0.08);
    border-radius: 20px;
    padding: 8px 14px;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    color: var(--text-secondary);
  }

  .like-button:hover {
    background: rgba(0, 0, 0, 0.06);
    transform: scale(1.05);
  }

  .like-button.liked {
    background: rgba(87, 6, 140, 0.1);
    border-color: rgba(87, 6, 140, 0.2);
    color: var(--nyu-purple);
  }

  .detail-section {
    margin-bottom: 32px;
  }

  .detail-section:last-child {
    margin-bottom: 0;
  }

  .detail-section-title {
    font-size: 21px;
    font-weight: 600;
    line-height: 1.28;
    letter-spacing: -0.003em;
    margin-bottom: 16px;
    color: var(--text-primary);
  }

  .detail-info-row {
    font-size: 17px;
    line-height: 1.47;
    color: var(--text-primary);
    margin-bottom: 8px;
  }

  .detail-info-row strong {
    font-weight: 600;
    color: var(--text-primary);
  }

  .detail-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 12px;
  }

  .detail-description {
    font-size: 17px;
    line-height: 1.58824;
    color: var(--text-primary);
    letter-spacing: -0.016em;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .evidence-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
    margin-top: 16px;
  }

  .evidence-item {
    background: var(--surface-secondary);
    border: 1px solid rgba(0, 0, 0, 0.06);
    border-radius: 12px;
    padding: 12px;
    transition: all 0.2s ease;
  }

  .evidence-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }

  .evidence-item img {
    width: 100%;
    border-radius: 8px;
    display: block;
    margin-bottom: 8px;
  }

  .evidence-filename {
    font-size: 12px;
    color: var(--text-light);
    margin-bottom: 6px;
  }

  .evidence-desc {
    font-size: 13px;
    color: var(--text-secondary);
    background: white;
    padding: 8px 10px;
    border-radius: 6px;
    line-height: 1.4;
  }

  .evidence-desc strong {
    font-weight: 600;
  }

  .alert-box {
    background: rgba(255, 107, 53, 0.04);
    border: 1px solid rgba(255, 107, 53, 0.12);
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 20px;
    font-size: 15px;
    line-height: 1.47;
    color: var(--text-secondary);
  }

  .alert-box strong {
    color: var(--text-primary);
    display: block;
    margin-bottom: 6px;
  }

  /* Comments Section */
  .comments-section {
    margin-top: 40px;
  }

  .comment-input-wrapper {
    margin-bottom: 32px;
  }

  .comment-textarea {
    width: 100%;
    padding: 16px;
    border: 1px solid rgba(0, 0, 0, 0.12);
    border-radius: 12px;
    resize: vertical;
    font-family: inherit;
    font-size: 15px;
    line-height: 1.47;
    background: white;
    transition: all 0.2s ease;
  }

  .comment-textarea:focus {
    outline: none;
    border-color: var(--nyu-purple);
    box-shadow: 0 0 0 3px rgba(87, 6, 140, 0.1);
  }

  .comment-textarea:hover {
    border-color: rgba(0, 0, 0, 0.2);
  }

  .comment-footer-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 12px;
  }

  .char-counter {
    font-size: 13px;
    color: var(--text-light);
    font-weight: 500;
  }

  .btn-submit-comment {
    padding: 10px 24px;
    background: var(--nyu-purple);
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn-submit-comment:hover {
    background: var(--nyu-purple-dark);
    transform: scale(1.02);
  }

  .btn-submit-comment:active {
    transform: scale(0.98);
  }

  .btn-submit-comment:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .comment-item {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.08);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 12px;
    transition: all 0.2s ease;
  }

  .comment-item:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    transform: translateY(-1px);
  }

  .comment-item.reply {
    margin-left: 32px;
    background: var(--surface-secondary);
    border-left: 3px solid var(--nyu-purple);
  }

  .comment-content {
    font-size: 15px;
    line-height: 1.53;
    color: var(--text-primary);
    margin-bottom: 12px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .comment-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
    color: var(--text-light);
  }

  .btn-reply {
    background: rgba(87, 6, 140, 0.08);
    border: none;
    color: var(--nyu-purple);
    cursor: pointer;
    border-radius: 16px;
    font-size: 13px;
    padding: 6px 14px;
    font-weight: 600;
    transition: all 0.2s ease;
  }

  .btn-reply:hover {
    background: var(--nyu-purple);
    color: white;
  }

  .reply-indicator {
    background: rgba(87, 6, 140, 0.06);
    border: 1px solid rgba(87, 6, 140, 0.12);
    border-radius: 10px;
    padding: 12px 16px;
    margin-bottom: 12px;
    font-size: 14px;
    color: var(--nyu-purple);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .btn-cancel-reply {
    background: var(--nyu-purple);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 4px 10px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
  }

  .btn-cancel-reply:hover {
    background: var(--nyu-purple-dark);
  }

  .loading-spinner {
    text-align: center;
    padding: 40px;
    color: var(--text-light);
  }

  .empty-state {
    text-align: center;
    padding: 40px;
    color: var(--text-secondary);
  }

  .action-buttons {
    display: flex;
    gap: 12px;
    margin-top: 32px;
    flex-wrap: wrap;
  }

  .btn-action {
    padding: 12px 24px;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-block;
  }

  .btn-action.primary {
    background: var(--nyu-purple);
    color: white;
    border: none;
  }

  .btn-action.primary:hover {
    background: var(--nyu-purple-dark);
    transform: translateY(-1px);
  }

  .btn-action.secondary {
    background: white;
    color: var(--text-primary);
    border: 1px solid rgba(0, 0, 0, 0.12);
  }

  .btn-action.secondary:hover {
    background: var(--surface-secondary);
    border-color: rgba(0, 0, 0, 0.2);
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  @media (max-width: 768px) {
    .detail-hero h1 {
      font-size: 32px;
    }

    .detail-card {
      padding: 24px;
    }

    .like-button {
      top: 16px;
      right: 16px;
    }

    .comment-item.reply {
      margin-left: 16px;
    }

    .evidence-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<div class="detail-hero">
  <h1>{{ t('detail.page_title') }}</h1>
  <p>{{ t('detail.page_subtitle') }}</p>
</div>

<div class="detail-container">
  <div class="detail-card">
    <!-- Like Button -->
    <button id="like-btn" class="like-button" data-submission-id="{{ sub.id }}">
      <svg class="like-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/>
      </svg>
      <span class="like-count">{{ sub.like_count }}</span>
    </button>

    <!-- Basic Info -->
    <div class="detail-section">
      <div class="detail-section-title">{{ t('detail.basic_info') }}</div>
      <div class="detail-info-row">
        <strong>{{ t('detail.ta_name') }}</strong> {{ sub.get_display_name(masked=from_privacy) }}
      </div>
    </div>

    <!-- Tags -->
    <div class="detail-section">
      <div class="detail-section-title">{{ t('detail.tags_label') }}</div>
      <div class="detail-badges">
        {% if sub.tag_loyal %}<span class="badge badge-positive">{{ t('tags.loyal') }}</span>{% endif %}
        {% if sub.tag_stable %}<span class="badge badge-positive">{{ t('tags.stable') }}</span>{% endif %}
        {% if sub.tag_sincere %}<span class="badge badge-positive">{{ t('tags.sincere') }}</span>{% endif %}
        {% if sub.tag_humorous %}<span class="badge badge-positive">{{ t('tags.humorous') }}</span>{% endif %}
        {% if sub.tag_positive %}<span class="badge badge-negative">{{ t('tags.cheating') }}</span>{% endif %}
        {% if sub.tag_calm %}<span class="badge badge-negative">{{ t('tags.cold_violence') }}</span>{% endif %}
        {% if sub.tag_leadership %}<span class="badge badge-negative">{{ t('tags.pua') }}</span>{% endif %}
        {% if sub.tag_homework_heavy %}<span class="badge badge-negative">{{ t('tags.money') }}</span>{% endif %}
        {% if sub.tag_custom %}<span class="badge badge-neutral">{{ sub.tag_custom }}</span>{% endif %}
      </div>
    </div>

    <!-- Description -->
    <div class="detail-section">
      <div class="detail-section-title">{{ t('detail.description_label') }}</div>
      <div class="detail-description">{{ sub.description | safe_newlines | safe }}</div>
    </div>

    <!-- Evidence -->
    <div class="detail-section">
      <div class="detail-section-title">{{ t('detail.evidence_thumbnails') }}</div>
      {% if sub.allow_public_evidence %}
        <div class="alert-box">
          <strong>{{ t('detail.privacy_notice_title') }}</strong>
          {{ t('detail.privacy_notice_desc') }}
        </div>
        <div class="evidence-grid">
          {% for ev in sub.evidences %}
            {% if ev.category in ['image','chat_image','video','chat_video','document'] %}
              <div class="evidence-item">
                <img src="/evidence/{{ sub.id }}/{{ ev.id }}" alt="{{ ev.original_filename }}" />
                <div class="evidence-filename">
                  {{ t('detail.file') }} {{ ev.original_filename }}
                </div>
                {% if ev.description %}
                  <div class="evidence-desc">
                    <strong>{{ t('detail.description') }}</strong> {{ ev.description }}
                  </div>
                {% endif %}
              </div>
            {% endif %}
          {% endfor %}
        </div>
      {% else %}
        <p style="color: var(--text-light); font-size: 15px;">{{ t('detail.evidence_not_public') }}</p>
      {% endif %}
    </div>

    <!-- Appeal Hint -->
    <div class="alert-box">
      {{ t('detail.appeal_hint') }}
    </div>
  </div>

  <!-- Comments Section -->
  <div class="detail-card comments-section">
    <div class="detail-section-title">{{ t('detail.comments_section') }}</div>

    <!-- Comment Input -->
    <div class="comment-input-wrapper">
      <form id="comment-form">
        <input type="hidden" id="reply-to-id" value="">
        <div id="reply-indicator" class="reply-indicator" style="display: none;">
          <span id="reply-indicator-text"></span>
          <button type="button" id="cancel-reply" class="btn-cancel-reply">{{ t('detail.cancel_reply') }}</button>
        </div>
        <textarea
          id="comment-input"
          class="comment-textarea"
          placeholder="{{ t('detail.comment_placeholder') }}"
          rows="4"
          maxlength="1000"
        ></textarea>
        <div class="comment-footer-bar">
          <span id="char-count" class="char-counter">0/1000</span>
          <button type="submit" id="submit-comment-btn" class="btn-submit-comment">
            {{ t('detail.post_comment') }}
          </button>
        </div>
      </form>
    </div>

    <!-- Comments List -->
    <div id="comments-list">
      <div id="comments-loading" class="loading-spinner">
        <div style="display: inline-flex; align-items: center; gap: 8px;">
          <div style="width: 16px; height: 16px; border: 2px solid rgba(0,0,0,0.1); border-top: 2px solid var(--nyu-purple); border-radius: 50%; animation: spin 1s linear infinite;"></div>
          {{ t('detail.loading_comments') }}
        </div>
      </div>
      <div id="comments-container"></div>
      <div id="comments-empty" class="empty-state" style="display: none;">
        <div style="font-size: 15px; color: var(--text-secondary); margin-bottom: 4px;">{{ t('detail.no_comments') }}</div>
        <div style="font-size: 13px; color: var(--text-light);">{{ t('detail.first_comment') }}</div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="action-buttons">
    <a href="/appeal/{{ sub.id }}" class="btn-action primary">{{ t('detail.appeal_btn') }}</a>
    <a href="/" class="btn-action secondary">{{ t('detail.back_btn') }}</a>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const likeBtn = document.getElementById('like-btn');
    const submissionId = likeBtn.dataset.submissionId;
    const likeIcon = likeBtn.querySelector('.like-icon');
    const likeCount = likeBtn.querySelector('.like-count');

    let isLiked = false;
    let isLoading = false;

    // Get like status
    function fetchLikeStatus() {
        fetch(`/api/like-status/${submissionId}`)
            .then(response => response.json())
            .then(data => {
                if (!data.error) {
                    isLiked = data.liked;
                    updateLikeUI(data.like_count);
                }
            })
            .catch(error => console.error('Error:', error));
    }

    // Update like UI
    function updateLikeUI(count) {
        likeCount.textContent = count;
        if (isLiked) {
            likeBtn.classList.add('liked');
            likeIcon.style.fill = 'currentColor';
        } else {
            likeBtn.classList.remove('liked');
            likeIcon.style.fill = 'none';
        }
    }

    // Handle like click
    likeBtn.addEventListener('click', function() {
        if (isLoading) return;

        isLoading = true;
        likeBtn.style.opacity = '0.6';

        fetch(`/api/like/${submissionId}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (!data.error) {
                    isLiked = data.liked;
                    updateLikeUI(data.like_count);
                }
            })
            .catch(error => console.error('Error:', error))
            .finally(() => {
                isLoading = false;
                likeBtn.style.opacity = '1';
            });
    });

    fetchLikeStatus();

    // Comments functionality
    const commentForm = document.getElementById('comment-form');
    const commentInput = document.getElementById('comment-input');
    const submitBtn = document.getElementById('submit-comment-btn');
    const charCount = document.getElementById('char-count');
    const replyToId = document.getElementById('reply-to-id');
    const replyIndicator = document.getElementById('reply-indicator');
    const replyIndicatorText = document.getElementById('reply-indicator-text');
    const cancelReplyBtn = document.getElementById('cancel-reply');
    const commentsLoading = document.getElementById('comments-loading');
    const commentsContainer = document.getElementById('comments-container');
    const commentsEmpty = document.getElementById('comments-empty');

    // Character counter
    commentInput.addEventListener('input', function() {
        const length = this.value.length;
        charCount.textContent = `${length}/1000`;
        if (length > 900) charCount.style.color = '#DC2626';
        else if (length > 700) charCount.style.color = '#B85C00';
        else charCount.style.color = 'var(--text-light)';
    });

    // Render comment
    function renderComment(comment, level = 0) {
        const marginLeft = level * 32;
        const isReply = level > 0;

        let html = `
            <div class="comment-item ${isReply ? 'reply' : ''}" style="margin-left: ${marginLeft}px;">
                <div class="comment-content">${escapeHtml(comment.content)}</div>
                <div class="comment-meta">
                    <span>${comment.created_at}</span>
                    <button class="btn-reply" onclick="startReply(${comment.id}, '${escapeHtml(comment.content).substring(0, 30)}...')">
                        {{ t('detail.reply_btn') }}
                    </button>
                </div>
            </div>
        `;

        if (comment.replies && comment.replies.length > 0) {
            comment.replies.forEach(reply => {
                html += renderComment(reply, level + 1);
            });
        }

        return html;
    }

    // Load comments
    function loadComments() {
        fetch(`/api/comments/${submissionId}`)
            .then(response => response.json())
            .then(data => {
                commentsLoading.style.display = 'none';

                if (data.comments && data.comments.length > 0) {
                    let html = '';
                    data.comments.forEach(comment => {
                        html += renderComment(comment);
                    });
                    commentsContainer.innerHTML = html;
                    commentsContainer.style.display = 'block';
                    commentsEmpty.style.display = 'none';
                } else {
                    commentsContainer.style.display = 'none';
                    commentsEmpty.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                commentsLoading.innerHTML = '<div style="color: #DC2626;">加载评论失败</div>';
            });
    }

    // Escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML.replace(/\n/g, '<br>');
    }

    // Start reply
    window.startReply = function(commentId, preview) {
        replyToId.value = commentId;
        replyIndicatorText.textContent = `{{ t('detail.replying_to') }} ${preview}`;
        replyIndicator.style.display = 'flex';
        commentInput.focus();
    };

    // Cancel reply
    cancelReplyBtn.addEventListener('click', function() {
        replyToId.value = '';
        replyIndicator.style.display = 'none';
    });

    // Submit comment
    commentForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const content = commentInput.value.trim();
        if (!content) return;

        submitBtn.disabled = true;
        submitBtn.textContent = '提交中...';

        const data = {
            submission_id: parseInt(submissionId),
            content: content
        };

        if (replyToId.value) {
            data.parent_id = parseInt(replyToId.value);
        }

        fetch('/api/comments', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                commentInput.value = '';
                charCount.textContent = '0/1000';
                replyToId.value = '';
                replyIndicator.style.display = 'none';
                loadComments();
            }
        })
        .catch(error => console.error('Error:', error))
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.textContent = '{{ t('detail.post_comment') }}';
        });
    });

    loadComments();
});
</script>
{% endblock %}
